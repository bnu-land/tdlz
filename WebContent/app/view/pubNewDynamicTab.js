/*
 * File: app/view/pubNewDynamicTab.js
 *
 * This file was generated by Sencha Architect version 3.1.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.view.pubNewDynamicTab', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.pubNewDynamicTab',

    requires: [
        'Ext.form.Panel',
        'Ext.grid.Panel',
        'Ext.grid.RowNumberer',
        'Ext.grid.View',
        'Ext.toolbar.Paging',
        'Ext.form.Label',
        'Ext.form.field.Date',
        'Ext.button.Button',
        'Ext.selection.CheckboxModel'
    ],

    height: 538,
    id: 'pubNewDynamicTab',
    width: 768,
    layout: 'fit',
    title: '最新动态',

    initComponent: function() {
        var me = this;

        Ext.applyIf(me, {
            items: [
                {
                    xtype: 'form',
                    height: 348,
                    id: 'pubNewDynamicForm',
                    layout: 'fit',
                    bodyPadding: 10,
                    title: '',
                    items: [
                        {
                            xtype: 'gridpanel',
                            autoShow: true,
                            height: 240,
                            id: 'pubNewDynamicTable',
                            width: 700,
                            title: '',
                            forceFit: true,
                            store: 'pubNewDynamicStore',
                            columns: [
                                {
                                    xtype: 'gridcolumn',
                                    hidden: true,
                                    dataIndex: 'articleId',
                                    text: 'id'
                                },
                                {
                                    xtype: 'rownumberer',
                                    width: 48,
                                    text: '记录号'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    width: 82,
                                    dataIndex: 'articleName',
                                    text: '标题'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    dataIndex: 'articleContent',
                                    text: '内容'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    width: 85,
                                    dataIndex: 'articlePublishtime',
                                    text: '发布日期'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    hidden: true,
                                    dataIndex: 'articleUrl',
                                    text: '详细页面路径'
                                }
                            ],
                            dockedItems: [
                                {
                                    xtype: 'pagingtoolbar',
                                    dock: 'bottom',
                                    width: 360,
                                    displayInfo: true,
                                    displayMsg: '显示{0} - {1} 条，共计{2}条',
                                    emptyMsg: '没有数据',
                                    store: 'pubNewDynamicStore'
                                },
                                {
                                    xtype: 'toolbar',
                                    dock: 'top',
                                    items: [
                                        {
                                            xtype: 'label',
                                            text: '发布日期：'
                                        },
                                        {
                                            xtype: 'datefield',
                                            id: 'searchDate_pubNewDynamic',
                                            fieldLabel: '',
                                            format: 'Y-m-d'
                                        },
                                        {
                                            xtype: 'textfield',
                                            id: 'searchField_pubNewDynamic',
                                            width: 157,
                                            fieldLabel: ''
                                        },
                                        {
                                            xtype: 'button',
                                            handler: function(button, event) {
                                                var searchDate=Ext.util.Format.date(Ext.getCmp('searchDate_pubNewDynamic').getValue(),'Y-m-d');
                                                var mystore=Ext.StoreMgr.get('pubNewDynamicStore'); //获得store对象
                                                //在load事件中添加参数
                                                mystore.load(
                                                {params:{
                                                    start:"0",
                                                    limit:"10",
                                                    searchField:Ext.getCmp('searchField_pubNewDynamic').getValue(),
                                                    searchDate:searchDate
                                                }
                                            }
                                            );


                                            },
                                            border: '',
                                            text: '搜索'
                                        },
                                        {
                                            xtype: 'button',
                                            handler: function(button, event) {

                                                var win=new Ext.Window({
                                                    height: 462,
                                                    id: 'gx_pubNewDynamic_Window',
                                                    width: 577,
                                                    layout: {
                                                        type: 'absolute'
                                                    },
                                                    title: '新建内容',
                                                    modal: true,
                                                    items: [
                                                    {
                                                        xtype: 'form',
                                                        x: 0,
                                                        y: 0,
                                                        height: 440,
                                                        jsonSubmit: true,
                                                        id: 'gx_pubNewDynamic_form_add',
                                                        layout: {
                                                            type: 'absolute'
                                                        },
                                                        bodyPadding: 10,
                                                        title: '',
                                                        url: 'add_PubNewDynamic',
                                                        items: [
                                                        {
                                                            xtype: 'label',
                                                            x: 30,
                                                            y: 30,
                                                            height: 20,
                                                            width: 40,
                                                            text: '标题：'
                                                        },
                                                        {
                                                            xtype: 'label',
                                                            x: 30,
                                                            y: 80,
                                                            height: 20,
                                                            width: 40,
                                                            text: '内容：'
                                                        },
                                                        {
                                                            xtype: 'button',
                                                            x: 330,
                                                            y: 360,
                                                            width: 70,
                                                            text: '保存',
                                                            handler:function()
                                                            {

                                                                var myform=Ext.getCmp('gx_pubNewDynamic_form_add').getForm();
                                                                if (myform.isValid()) { // make sure the form contains valid data before submitting
                                                                    myform.submit({
                                                                        success: function(form, action) {
                                                                            Ext.Msg.alert('提示', action.result.msg);
                                                                            var searchDate=Ext.util.Format.date(Ext.getCmp('searchDate_pubNewDynamic').getValue(),'Y-m-d');
                                                                            var mystore=Ext.StoreMgr.get('pubNewDynamicStore'); //获得store对象
                                                                            //在load事件中添加参数
                                                                            mystore.load(
                                                                            {params:{
                                                                                start:"0",
                                                                                limit:"10",
                                                                                searchField:Ext.getCmp('searchField_pubNewDynamic').getValue(),
                                                                                searchDate:searchDate
                                                                            }} );
                                                                            win.close();
                                                                        },
                                                                        failure: function(form, action) {
                                                                            Ext.Msg.alert('提示', action.result.msg);
                                                                            win.close();
                                                                        }
                                                                    });
                                                                } else {
                                                                    Ext.Msg.alert('注意', '填写信息不能为空，请检查！');
                                                                }


                                                                return;

                                                            }
                                                        },
                                                        {
                                                            xtype: 'button',
                                                            x: 160,
                                                            y: 360,
                                                            width: 70,
                                                            text: '取消',
                                                            handler:function(){
                                                                win.close();
                                                            }
                                                        },
                                                        {
                                                            xtype: 'textareafield',
                                                            x: 80,
                                                            y: 30,
                                                            height: 22,
                                                            width: 410,
                                                            fieldLabel: '',
                                                            allowBlank:false,
                                                            name: 'articleName'
                                                        },
                                                        {
                                                            xtype: 'textareafield',
                                                            x: 80,
                                                            y: 80,
                                                            height: 242,
                                                            width: 410,
                                                            overflowY: 'auto',
                                                            fieldLabel: '',
                                                            allowBlank:false,
                                                            name: 'articleContent'
                                                        }
                                                        ]
                                                    }
                                                    ]
                                                });
                                                win.show();

                                            },
                                            href: '',
                                            text: '添加+'
                                        },
                                        {
                                            xtype: 'button',
                                            handler: function(button, event) {

                                                var grid=this.up('grid');
                                                var record =grid.getSelectionModel().getSelection();

                                                if(record.length===0){
                                                    Ext.Msg.alert('提示','请先选择您要操作的行！');
                                                    return;
                                                }
                                                else
                                                {
                                                    var ids='';
                                                    for(var i=0;i<record.length;i++)
                                                    {
                                                        ids+=record[i].get("articleId");
                                                        if(i<record.length-1)ids=ids+",";
                                                    }

                                                    Ext.Ajax.request({
                                                        waitMsg:'正在发送，请等待...',
                                                        url:'del_PubTicketIn',
                                                        params:{ids:ids},
                                                        success: function(form, action) {
                                                            Ext.Msg.alert('success','删除成功！');
                                                            var searchDate=Ext.util.Format.date(Ext.getCmp('searchDate_pubNewDynamic').getValue(),'Y-m-d');
                                                            var mystore=Ext.StoreMgr.get('pubNewDynamicStore'); //获得store对象
                                                            //在load事件中添加参数
                                                            mystore.load(
                                                            {params:{
                                                                start:"0",
                                                                limit:"10",
                                                                searchField:Ext.getCmp('searchField_pubNewDynamic').getValue(),
                                                                searchDate:searchDate
                                                            }} );
                                                            win.close();
                                                        },
                                                        failure:function(){
                                                            Ext.Msg.alert('failed','删除失败！');

                                                        }
                                                    });
                                                }

                                            },
                                            href: '',
                                            text: '删除-'
                                        }
                                    ]
                                }
                            ],
                            selModel: Ext.create('Ext.selection.CheckboxModel', {

                            }),
                            listeners: {
                                cellclick: {
                                    fn: me.onDealInfoPublishTableCellClick,
                                    scope: me
                                }
                            }
                        }
                    ],
                    listeners: {
                        beforeshow: {
                            fn: me.onPubNewDynamicFormBeforeShow,
                            scope: me
                        }
                    }
                }
            ]
        });

        me.callParent(arguments);
    },

    onDealInfoPublishTableCellClick: function(tableview, td, cellIndex, record, tr, rowIndex, e, eOpts) {

        if(cellIndex===undefined || cellIndex<2) return;

        var win=new Ext.Window({
            height: 426,
            id: 'gxpubNewDynamicWindow_update',
            width: 490,
            layout: {
                type: 'absolute'
            },
            title: '改变内容',
            modal: true,
            items: [
            {
                xtype: 'form',
                x: 0,
                y: 0,
                height: 440,
                id: 'pubNewDynamic_update_Form',
                layout: {
                    type: 'absolute'
                },
                bodyPadding: 10,
                title: '',
                jsonSubmit: true,
                url: 'update_PubNewDynamic',
                items: [
                {
                    xtype: 'label',
                    x: 30,
                    y: 30,
                    height: 20,
                    width: 40,
                    text: '标题：'
                },
                {
                    xtype: 'label',
                    x: 30,
                    y: 80,
                    height: 20,
                    width: 40,
                    text: '内容：'
                },
                {
                    xtype: 'label',
                    x: 20,
                    y: 300,
                    height: 20,
                    width: 60,
                    text: '发布日期：'
                },
                {
                    xtype: 'button',
                    x: 320,
                    y: 340,
                    width: 70,
                    text: '保存',
                    handler:function(){
                        var myform=Ext.getCmp('pubNewDynamic_update_Form').getForm();
                        if (myform.isValid()) { // make sure the form contains valid data before submitting
                            myform.submit({
                                success: function(form, action) {
                                    Ext.Msg.alert('提示', action.result.msg);
                                    var searchDate=Ext.util.Format.date(Ext.getCmp('searchDate_pubNewDynamic').getValue(),'Y-m-d');
                                    var mystore=Ext.StoreMgr.get('pubNewDynamicStore'); //获得store对象
                                    //在load事件中添加参数
                                    mystore.load(
                                    {params:{
                                        start:"0",
                                        limit:"10",
                                        searchField:Ext.getCmp('searchField_pubNewDynamic').getValue(),
                                        searchDate:searchDate
                                    }} );
                                    win.close();
                                },
                                failure: function(form, action) {
                                    Ext.Msg.alert('提示', action.result.msg);
                                    win.close();
                                }
                            });
                        } else {
                            Ext.Msg.alert('注意', '填写信息不能为空，请检查！');
                        }


                        return;

                    }
                },
                {
                    xtype: 'button',
                    x: 120,
                    y: 340,
                    width: 70,
                    text: '取消',
                    handler:function(){
                        win.close();
                    }
                },
                {
                    xtype: 'textareafield',
                    id:'title_pubNewDynamic',
                    x: 80,
                    y: 30,
                    height: 22,
                    width: 350,
                    fieldLabel: '',
                    name: 'articleName',
                    allowBlank: false
                },
                {
                    xtype: 'textareafield',
                    id:'content_pubNewDynamic',
                    x: 80,
                    y: 80,
                    height: 202,
                    width: 350,
                    overflowY: 'auto',
                    fieldLabel: '',
                    name: 'articleContent',
                    allowBlank: false
                },
                {
                    xtype: 'textareafield',
                    id:'id_pubNewDynamic',
                    x: 20,
                    y: 0,
                    height: 22,
                    hidden: true,
                    width: 80,
                    fieldLabel: '',
                    name: 'articleId',
                    allowBlank: false
                },
                {
                    xtype: 'datefield',
                    id:'date_pubNewDynamic',
                    x: 80,
                    y: 300,
                    width: 190,
                    fieldLabel: '',
                    name: 'articlePublishtime',
                    allowBlank: false
                }
                ]
            }
            ]
        });

        Ext.getCmp('id_pubNewDynamic').setValue(record.data.articleId);
        Ext.getCmp('title_pubNewDynamic').setValue(record.data.articleName);
        Ext.getCmp('content_pubNewDynamic').setValue(record.data.articleContent);
        Ext.getCmp('date_pubNewDynamic').setValue(record.data.articlePublishtime);

        win.show();

    },

    onPubNewDynamicFormBeforeShow: function(component, eOpts) {
        Ext.Msg.alert('tipd','test  before form 显示');
        Ext.getCmp('pubNewDynamicStore').load();
    }

});