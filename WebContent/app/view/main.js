/*
 * File: app/view/main.js
 *
 * This file was generated by Sencha Architect version 2.2.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.view.main', {
    extend: 'Ext.container.Container',
    alias: 'widget.main',

    id: 'main',
    width: 150,
    layout: {
        type: 'card'
    },
    
    initComponent: function() {
        var me = this;

  
        Ext.applyIf(me, {
            items: [
                
                {
                	 xtype: 'panel',
                     title: '任务管理',
                     layout: 'fit',
                     items: [
						{
						    xtype: 'gridpanel',
						    id: 'raskGrid',
						    title: '',
						    store: 'raskStore',
						    columns: [
						        {
						            xtype: 'rownumberer'
						        },
						        {
						            xtype: 'gridcolumn',
						            dataIndex: 'rwId',
						            text: '任务编号'
						        },
						        {
						            xtype: 'gridcolumn',
						            dataIndex: 'projectId',
						            text: '项目编号'
						        },
						        {
						            xtype: 'gridcolumn',
						            dataIndex: 'projectName',
						            text: '项目名称'
						        },
						        {
						            xtype: 'gridcolumn',
						            dataIndex: 'rwContent',
						            text: '任务内容'
						        },
						        {
						            xtype: 'gridcolumn',
						            dataIndex: 'rwClass',
						            text: '任务类别'
						        },
						        {
						            xtype: 'datecolumn',
						            dataIndex: 'rwGeneratetime',
						            text: '任务生成时间',
						            format: 'Y-m-d'
						        },
						        {
						            xtype: 'datecolumn',
						            dataIndex: 'rwStarttime',
						            text: '任务执行时间',
						            format: 'Y-m-d'
						        },
						        {
						            xtype: 'datecolumn',
						            dataIndex: 'rwEndtime',
						            text: '任务结束时间',
						            format: 'Y-m-d'
						        },
						        {
						            xtype: 'datecolumn',
						            dataIndex: 'rwSubmittime',
						            text: '任务提交时间',
						            format: 'Y-m-d'
						        },
						        {
						            xtype: 'booleancolumn',
						            dataIndex: 'rwIsfinished',
						            text: '任务是否完成'
						        },
						        {
						            xtype: 'gridcolumn',
						            dataIndex: 'rwResponsiblePerson',
						            text: '下达任务人'
						        }
						    ],
						    dockedItems: [
						        {
						            xtype: 'pagingtoolbar',
						            dock: 'bottom',
						            width: 360,
						            displayInfo: true,
						            store: 'raskStore'
						        },
						        {
						            xtype: 'toolbar',
						            dock: 'top',
						            items: [
						                {
						                    xtype: 'button',
						                    handler: function(button, event) {
					                    	      
						                    	var raskWindow = Ext.create('Ext.window.Window',{
						                    		width: 830,
						                    	    layout: {
						                    	        type: 'fit'
						                    	    },
						                    	    title: '新增任务',
					                    	    		
				                    	    		constrain: true,
				                    	    		items: [				                    	    		     
														{
														    xtype: 'form',
														    height: 500,														 
														    layout: {
														        type: 'absolute'
														    },
							
														    bodyPadding: 10,
								
														    items: [
														        {
														            xtype: 'textfield',
														        
														            width: 670,
														            fieldLabel: '任务编号',
														            labelWidth: 80,
														            name: 'rwId'
														        },
														        {
														            xtype: 'textfield',
														            x: 10,
														            y: 40,
														            width: 780,
														            fieldLabel: '项目名称',
														            labelWidth: 80,
														            name: 'projectName'
														        },
														        {
														            xtype: 'textfield',
														            x: 10,
														            y: 70,
														            width: 780,
														            fieldLabel: '项目编号',
														            labelWidth: 80,
														            name: 'projectId'
														        },
														        {
														            xtype: 'combobox',
														            x: 10,
														            y: 100,
														            width: 780,
														            fieldLabel: '任务类型',
														            labelWidth: 80,
														            name: 'rwClass',
														            store: new Ext.data.ArrayStore({
    	                                                            	fields: ['value', 'text'],
    	                                                            	data: [
    	                                                            	    ['1', '规划监测'],
    	                                                            	    ['2', '拆迁监测']   	                                                            	   
    	                                                            	],
    	                                                            }),
    	                                                            mode: 'local',
    	                                                            valueField: 'value',
    	                                                            editable: false,
    	                                                            displayField: 'text',           	           
    	                                                            value: '1'
														        },
														        {
														            xtype: 'textfield',
														            x: 10,
														            y: 130,
														            width: 780,
														            fieldLabel: '任务下达人',
														            labelWidth: 80,
														            name: 'rwResponsiblePerson'
														        },
														        {
														            xtype: 'datefield',
														            x: 10,
														            y: 170,
														            width: 780,
														            fieldLabel: '任务执行时间',
														            labelWidth: 80,
														            name: 'rwStarttime',
														            format: 'Y-m-d'
														        },
														        {
														            xtype: 'datefield',
														            x: 10,
														            y: 200,
														            width: 780,
														            fieldLabel: '任务截止时间',
														            labelWidth: 80,
														            name: 'rwEndtime',
														            format: 'Y-m-d'
														        },
														        {
														            xtype: 'textareafield',
														            x: 10,
														            y: 240,
														            height: 180,
														            width: 780,
														            fieldLabel: '任务描述',
														            labelWidth: 80,
														            name: 'rwContent'
														        },
														        {
														            xtype: 'button',
														            handler: function(button, event) {
														                var form = this.up('form').getForm(); // get the basic form
														                var raskForm = raskWindow.getComponent(0);
														
														                if (form.isValid()) { // make sure the form contains valid data before submitting
														                    form.submit({
														                        url:'addRask.action', 
														                        params: {
														                        	rwId : "" + raskForm.getComponent(0).getValue() + "",
														                        	projectId: "" + raskForm.getComponent(1).getValue() + "",
														                        	projectName: "" + raskForm.getComponent(2).getValue() + "",
														                        	rwContent: "" + raskForm.getComponent(3).getValue() + "",
														                        	rwClass: "" + raskForm.getComponent(4).getRawValue() + "",														                        	
														                        	rwStarttime: "" + Ext.util.Format.date(raskForm.getComponent(5).getValue(), "Y-m-d") + "",
														                        	rwEndtime: "" + Ext.util.Format.date(raskForm.getComponent(6).getValue(), "Y-m-d") + "",														                        	
														                        	rwResponsiblePerson: "" + raskForm.getComponent(7).getValue() + ""
														                     
														                        },
														                        method: 'post',  
														                        success: function(form, action) {
														                        	Ext.Msg.alert('成功', '提交成功');
														                            var mystore = Ext.StoreMgr.get('raskStore'); //获得store对象                                                   
														                            mystore.load();  
														                            			
														                            raskWindow.close();
														                        },
														                        failure: function(form, action) {
														                            Ext.Msg.alert('失败', '提交失败');
														                        }
														                    });
														                } else { // display error alert if the data is invalid
														                Ext.Msg.alert('Invalid Data', 'Please correct form errors.');}
														            },
														            x: 230,
														            y: 440,
														            width: 100,
														            text: '确定'
														        },
														        {
														            xtype: 'button',
														            handler: function(button, event) {
														            	raskWindow.close();
														            },
														            x: 520,
														            y: 440,
														            height: 20,
														            width: 90,
														            text: '取消'
														        },
														        {
														            xtype: 'button',
														            handler: function(button, event) {
														
														                Date.prototype.format = function(format){ 
														                    var o = { 
														                        "M+" : this.getMonth()+1, //month 
														                        "d+" : this.getDate(), //day 
														                        "h+" : this.getHours(), //hour 
														                        "m+" : this.getMinutes(), //minute 
														                        "s+" : this.getSeconds(), //second 
														                        "q+" : Math.floor((this.getMonth()+3)/3), //quarter 
														                        "S" : this.getMilliseconds() //millisecond 
														                    }; 
														                    if(/(y+)/.test(format)) { 
														                        format = format.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length)); 
														                    } 
														                    for(var k in o) { 
														                        if(new RegExp("("+ k +")").test(format)) { 
														                            format = format.replace(RegExp.$1, RegExp.$1.length==1 ? o[k] : ("00"+ o[k]).substr((""+ o[k]).length)); 
														                        } 
														                    } 
														                    return format; 
														                }; 
														
														
														                var newDate = new Date();//日历实例化
														                var raskForm = raskWindow.getComponent(0);
														                var newRwId;
														                if (raskForm.getComponent(3).getValue() == '1') {
														                	newRwId = "GHJC"+newDate.format("yyyyMMddhhmmss");//当前日期格式化	
																		}else{
																			newRwId = "CQJC"+newDate.format("yyyyMMddhhmmss");//当前日期格式化	
																		}
														                
														                raskForm.getComponent(0).setValue(newRwId);
														            },
														            x: 700,
														            y: 10,
														            text: '生成任务编号'
														        }
														    ]
														},
				                    						 
				                    	    		]
				                    	    		 
				                    	        });
					                    	    
					                    	    raskWindow.show();
						                    },
						                    text: '任务下达'
						                },
						                {
						                    xtype: 'button',
						                    handler: function(button, event) {
						                        var grid = Ext.getCmp('raskGrid');
						                        //var gird = this.down('grid');
						                        var record = grid.getSelectionModel().getSelection();
						
						                        if(record.length === 0){
						                            Ext.Msg.alert('提示','请先选择您要操作的行！');    
						                            return;
						
						                        }else{
						
						                            var  ids =new Array(record.length);
						                            for(var i = 0;i<record.length;i++){
						                                ids[i] = record[i].get("rwId");
						
						                            }
						                            //Ext.Msg.alert('提示',ids);
						
						
						
						                            Ext.Ajax.request({
						                                url:'deleteRask.action',
						                                params:{ids:ids},        
						                                success:function(response){
						                                    Ext.Msg.alert('成功','删除成功');
						                                    var mystore = Ext.StoreMgr.get('raskStore');
						                                    mystore.load();         
						                                },
						                                failure:function(response){
						                                    Ext.Msg.alert('失败','删除失败');      
						                                }
						
						                            });
						
						
						                        }
						                    },
						                    icon: 'img/check.png',
						                    text: '删除'
						                }
						            ]
						        }
						    ],
						    selModel: Ext.create('Ext.selection.CheckboxModel', {
						
						    })
						},
						{
		                	xtype: 'container',
		                    region: 'center',
		                    id: 'ctnMain',
		                    layout: {
		                        type: 'border'
		                    },
		                    items: [
		                    {
			                    xtype: 'panel',
			                    title: '显示地图',

			                    region: 'center',
			                    
			                    html:  '<div id="totalProjectionMap" class="totalProjectionMapClass" style="width:100%;height:100%"></div>',
			                    
//			                    html: '<iframe src="Map.html" height=100% width=100% scrolling=auto></iframe>',
			                  
			                               
			                  },
			                  {
		                      	
		                          xtype: 'panel',
		                
		                          title: '工具',
		                          width: 200,
		                          height: 100,
		                          layout: {
		                          	type: 'vbox'
		                          },
		                  
		                          region: 'east',
		                          collapsed: true,
		                          collapsible: true,
		                          items: [
		                              {
		                              	xtype: 'button',
		                              	x: 1,
			                                y: 160,
			                                width: 70,
		                              	text: '缩小',
		                              	listeners: {
		                              		click: {
		                              			fn: me.onZoomOut,
		                              			scope: me
		                              		}
		                              	}
		                              }, 
		                              {
		                              	xtype: 'button',
		                              	text: '放大',
		                              	x: 1,
			                                y: 160,
			                                width: 70,
		                              	listeners: {
		                              		click: {
		                              			fn: me.onZoomIn,
		                              			scope: me
		                              		}
		                              	}
		                              },
		                              {
		                              	xtype: 'button',
		                              	text: '全范围显示',
		                              	x: 1,
			                                y: 160,
			                                width: 70,
		                              	listeners: {
		                              		click: {
		                              			fn: me.onExtent,
		                              			scope: me
		                              		}
		                              	}
		                              },
		                              {
		                              	xtype: 'button',
		                              	text: '取消选择',
		                              	x: 1,
			                                y: 160,
			                                width: 70,
		                              	listeners: {
		                              		click: {
		                              			fn: me.onCancel,
		                              			scope: me
		                              		}
		                              	}
		                              },
		                              {
		                                	xtype: 'button',
		                                	text: '图层控制',
		                                	x: 1,
		  	                                y: 160,
		  	                                width: 70,
		                                	listeners: {
		                                		click: {
		                                			fn: me.onLayerControl,
		                                			scope: me
		                                		}
		                                	}
		                              },
		                              {
		                              	xtype: 'button',
		                              	text: '全项目属性',
		                              	x: 1,
			                                y: 160,
			                                width: 70,
		                              	listeners: {
		                              		click: {
		                              			fn: me.onShowProject,
		                              			scope: me
		                              		}
		                              	}
		                              },
		                          ]
		                      }
			                ]
				                	
		                },
                     ]
                     
                }
               
                
                
            ]
        });
        
        me.callParent(arguments);
    	
    },
    
  //工具相关操作
    onZoomOut: function(button, e, eOpts) {
    	jsNavToolbar.activate(esri.toolbars.Navigation.ZOOM_OUT);
    	
    },
    
    onZoomIn: function(button, e, eOpts) {
    	
    	jsNavToolbar.activate(esri.toolbars.Navigation.ZOOM_IN);
    },
    onExtent: function(button, e, eOpts) {
    	
    	jsNavToolbar.zoomToFullExtent();
    },
    onCancel: function(button, e, eOpts) {
    	
    	jsNavToolbar.deactivate();
    },
    onLayerControl: function(button, e, eOpts) {
    	

    	var LayerPanel = Ext.create('Ext.form.Panel', {
    		title: '图层控制',
    		html: '<div id="Layeroperation" style="width:100%;height:100%"></div>'
    	});
	    var LayerWindow = Ext.create('Ext.window.Window',{
	    	
	    	title: '图层控制窗口',
	    	width: 200,
	    	constrain: true,
	    	height: 400,
	    	layout: {
	    		type: 'fit',
	    	},
	    	items: [	    		     
//	    		 {    			 
//					 xtype: 'panel',														 
//				     region: 'south',
//						items: [
//						{
//							  
//							xtype: 'button',
//							text: '确定',
//							handler: function(){
//							   LayerWindow.destroy();
//							},
//							width: 70,
//								  
//						},
//					]
//				}
						 
	    	]
	    		 
	    });
	    LayerWindow.add(LayerPanel);
	    
	    LayerWindow.show();
	    jstLoadLayerList(LayerPanel);
	    
    },
    
    onShowProject: function(button, e, eOpts) {
    	  
    	  var projectStore = Ext.create('Ext.data.Store', {
    		   
      	    proxy: {
      	        // load using HTTP
      	        type: 'ajax',
      	        url: 'showProject.action',  
      	        // the return will be XML, so lets set up a reader
      	        reader:{
          			type:"json",
          			root:"results",
          			totalProperty :'totalCount'		
          		},
          		actionMethods: {  
                      read: 'POST'  
                  },
          		writer:{
          			type:"json"
          		}
      	    },
      	    fields: [
  	            {name: 'projectNumber',  type: 'string', useNull: true},  
    	        {name: 'projectAddress',  type: 'string'},  
    	        {name: 'createTime',  type: 'auto'},
    	        {name: 'projectStatus', type: 'string'},
    	        {name: 'endTime', type: 'auto'},
    	        {name: 'projectDescription', type: 'string'},
    	      
        	  ]
   	    
    	  });
    	  projectStore.load({callback: function(records, operation, success){
    		  var projectPanel = Ext.create('Ext.grid.Panel', { 								    	  
    	    	  region: 'center',
    	    	  allowDeselect: true,
    	          columnLines: true,
    	          store: 'projectStore',
    	          columns: [		         									 
    					 {
    						 xtype: 'gridcolumn',
    	                    width: 75,
    	                    align: 'center',
    	                    dataIndex: 'projectNumber',
    	                    text: '项目编号'        										  
    					 },
    					 {
    						 xtype: 'gridcolumn',
    	                    width: 150,
    	                    align: 'center',
    	                    dataIndex: 'projectAddress',
    	                    text: '项目所在地'        										  
    					 },
    					 {
    						 xtype: 'datecolumn',
    	                    width: 75,
    	                    align: 'center',
    	                    dataIndex: 'createTime',
    	                    text: '创建时间'        										  
    					 },
    					 {
    						 xtype: 'gridcolumn',
    	                    width: 150,
    	                    align: 'center',
    	                    dataIndex: 'projectStatus',
    	                    text: '项目状态'        										  
    					 },	
    					 {
    						 xtype: 'datecolumn',
    	                    width: 75,
    	                    align: 'center',
    	                    dataIndex: 'endTime',
    	                    text: '结束时间'        										  
    					 },							 
    					 {
    						 xtype: 'gridcolumn',
    	                    width: 150,
    	                    align: 'center',
    	                    dataIndex: 'projectDescription',
    	                    text: '项目描述'        										  
    					 },
    					 {
    						 xtype: 'actioncolumn',
    	                    width: 75,
    	                    text: '项目统计',
                            items: [
                                    {
                                        handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                        
                                        }
                                    }
                              ]
                                       
    					 },
    					 
    			   ],
    			   
    	      });
    	      
    	      var projectWindow = Ext.create('Ext.window.Window',{
    	    		title: '所有项目基本信息',
    	    		width: 600,
    	    		constrain: true,
    	    		height: 600,
    	    		layout: {
    	    			type: 'border',
    	    		},
    	    		items: [
    	    		     
    	    		     {
    						 xtype: 'panel',														 
    						 region: 'south',
    						 items: [
    							  {
    								  
    								  xtype: 'button',
    								  text: '确定',
    								  handler: function(){
    									  projectWindow.destroy();
    								  },
    								  width: 70,
    								  
    							  },
    						 ]
    					 }
    						 
    	    		]
    	    		 
    	      });
    	     
    	      projectWindow.add(projectPanel);
    	      projectWindow.show();
    	  }});
    	  
	      
    },
    
   

});

