/*
 * File: app/view/proj.js
 *
 * This file was generated by Sencha Architect version 2.2.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.view.proj', {
    extend: 'Ext.container.Container',
    alias: 'widget.proj',

    id: 'proj',
    layout: {
        type: 'card'
    },

    initComponent: function() {
        var me = this;
        Ext.applyIf(me, {
            items: [
                {
                    xtype: 'form',
                    id: 'newProj',
                    title: '创建项目',
                    items: [
   
                        {
                            xtype: 'numberfield',
                            anchor: '100%',
                            id: 'idProj',
                            fieldLabel: '项目编号'
                        },
                        {
                            xtype: 'textfield',
                            anchor: '100%',
                            id: 'describeProj',
                            fieldLabel: '项目描述'
                        },
                        {
                            xtype: 'button',
                            id: 'submitProj',
                            text: '提交',
                            listeners: {
                                click: {
                                    fn: me.onSubmitProjClick,
                                    scope: me
                                }
                            }
                        }
                    ]
                },
                {
                    xtype: 'form',
                    layout: 'fit',
                    id: 'projectManage',
                    bodyPadding: 10,
                    title: '项目管理',
                    items: [
						{	
							xtype: 'gridpanel',
							emptyText: '没有项目可选择',             	    	
             	    	  	allowDeselect: true,
                            columnLines: true,
                            store: new Ext.data.ArrayStore({
                            	proxy:{
                            		type:"ajax",
                            		url:"showProject.action",
                            		
                            		reader:{
                            			type:"json",
                            			root:"results",
                            			totalProperty :'totalCount'		
                            		},
                            		actionMethods: {  
                                        read: 'POST'  
                                    },
                            		writer:{
                            			type:"json"
                            		}
                            	},
                            	autoLoad: true,
							    fields: [  	
							          {name: 'id', type: 'auto'},
							          {name: 'projectNumber', type: 'string'},
							          {name: 'projectAddress', type: 'string'},
							          {name: 'createTime', type: 'date'},
							          {name: 'projectStatus', type: 'string'},
							          {name: 'endTime', type: 'date'},
							          {name: 'projectDescription', type: 'string'},
							    ],  
                            }),
                            columns: [		         									 
                                   {
									   xtype: 'gridcolumn',
                                       width: 75,
                                       align: 'center',
                                       dataIndex: 'projectNumber',
                                       text: '项目编号'        										  
								   },
								   {
									   xtype: 'gridcolumn',
                                       width: 150,
                                       align: 'center',
                                       dataIndex: 'projectAddress',
                                       text: '项目所在地'        										  
								   },
								   {
									   xtype: 'datecolumn',
                                       width: 75,
                                       align: 'center',
                                       dataIndex: 'createTime',
                                       text: '立项时间'        										  
								   },
								   {
									   xtype: 'datecolumn',
                                       width: 75,
                                       align: 'center',
                                       dataIndex: 'endTime',
                                       text: '完成时间'        										  
								   },
								   {
									   xtype: 'gridcolumn',
                                       width: 75,
                                       align: 'center',
                                       dataIndex: 'projectStatus',
                                       text: '进展状况'        										  
								   },
								   
								   {
                                       xtype: 'actioncolumn',
                                       text: '查看详情',
                                       width: 75,
                                       items: [
                                            {
                                            	icon: 'img/check.png',  // Use a URL in the icon config
                                                tooltip: '详情',
                                            	handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                            		Ext.getCmp("tfProjID").setValue(record.get('projectNumber'));
                    		            			Ext.getCmp("tfProjLocation").setValue(record.get('projectAddress'));
                    		            			Ext.getCmp("dfProjTime").setValue(record.get('createTime'));
                    		            			Ext.getCmp("dfProjEndTime").setValue(record.get('endTime'));
                    		            			Ext.getCmp("cmbProjStatus").setRawValue(record.get('projectStatus'));
                    		            			Ext.getCmp("taProjDetails").setValue(record.get('projectDescription'));
                                            		Ext.getCmp("proj").getLayout().setActiveItem(3);
                                                },
                                            },
                                       ]
								   },
								   {
                                       xtype: 'actioncolumn',
                                       text: '下一阶段',
                                       width: 75,
                                       items: [
                                            {
                                            	icon: 'img/check.png',  // Use a URL in the icon config
                                                tooltip: '下一阶段',
                                            	handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                            		var jsStatus;
                                            		var jsProjectNumber = record.get('projectNumber');
                                            		switch (record.get("projectStatus")) {
													case '立项阶段':
														
														jsStatus = 1;
														break;
													case '规划阶段':
														jsStatus = 2;
														break;
													case '入库备案':
														jsStatus = 3;
														break;
													case '拆迁阶段':
														jsStatus = 4;
														break;
													case '项目完成':
														jsStatus =5;
														break;
													default:
														break;
													}
                                            		Ext.Msg.confirm('提示', '确认进入下一阶段吗?', isOK);
                                                    function isOK(id){
        	                                            if (id == 'yes') {
        	                                            	
		                                            		Ext.Ajax.request({
		                                            			url: 'modifyProject.action',
		                                            			params: {
		                                            				projectNumber: "" + jsProjectNumber + "",
		                                            				projectStatus : "" + jsStatus + "",
		                                            			},
		                                            			method: 'post',
		                                            			success: function(){
		                                            				Ext.Msg.alert("提示", "操作成功！");
		                                            				Ext.getCmp('projectManage').getComponent(0).getStore().reload();
		                                            			}
		                                            		})
        	                                            }
                                                    }
                                                },
                                            }
                                       ]
								   }
	     									 
							],
								 
							selModel: Ext.create('Ext.selection.CheckboxModel', {
							    	
                            }) 				
						},
                    ],
                    dockedItems: [{
                        xtype: 'toolbar',
                        dock: 'top',
                        items: [{
                            xtype: 'button',
                            icon: 'img/edit.png',
                            text: '新建项目',
                            handler: function(){
                            	newProjectForm = Ext.create('Ext.form.Panel', {
									  
                            		  height: 231,
                            		
                            		  autoScroll: true,
                            		  bodyPadding: 10,
                            		  title: '立项',
                            		  items: [
                            		       {         	                                            		    	   
	                                           xtype: 'datefield',
	                                           anchor: '100%',								                                           
	                                           fieldLabel: '设立时间',
	                                           editable: false,
	                                           value: new Date(),
	                                           format : 'Y-m-d',
	                                       },        
                                           {
	                                           xtype: 'textfield',
                                             anchor: '100%',								                                           
	                                           fieldLabel: '项目编号',		
	                                       },
	                                       {
	                                           xtype: 'textfield',
	                                           anchor: '100%',								                                           
	                                           fieldLabel: '项目所在地',		
	                                       },
	                                       {
	                                           xtype: 'textfield',
	                                           anchor: '100%',								                                           
	                                           fieldLabel: '进展状况',	
	                                           editable: false,
	                                           value: '立项阶段'
	                                       },
	                                       {
	                                           xtype: 'textareafield',
	                                           anchor: '100%',								                                           
	                                           fieldLabel: '项目描述',
	                                            
	                                       },
	                                       {
                                               xtype: 'button',
                                               text: '创建',
                                               handler: function(){
                                               var jsCreateTime = Ext.util.Format.date(newProjectForm.getComponent(0).getValue(), 'Y-m-d');
                                               var jsProjectNumber = newProjectForm.getComponent(1).getValue();
                                               var jsProjectAddress = newProjectForm.getComponent(2).getValue();
                                               var jsProjectStatus = newProjectForm.getComponent(3).getValue();
                                               var jsDescription = newProjectForm.getComponent(4).getValue();
                 
                                               Ext.Ajax.request({
                                                    //设置提交的地址  
                                                    url:'addProject.action',  
                                                    //设置提交的方式为post  
                                                    
                                                    params : {
                                        				createTime : "" + jsCreateTime + "",
                                        				projectNumber : "" + jsProjectNumber + "",
                                        				projectAddress : "" + jsProjectAddress + "",
                                        				projectStatus : "" + jsProjectStatus + "",
                                        				projectDescription : "" + jsDescription + "",
                                        				
                                        			},
                                                    method: 'post',  


                                                    //网络成功返回  
                                                    success: function(form, action) {  
                                                    	Ext.Msg.show({
                                                    	    title: '结果信息',
                                                    	    msg: '创建成功',
                                                    	    width: 300,
                                                    	    buttons: Ext.Msg.OK,
                                                    	    icon: Ext.window.MessageBox.INFO
                                                    	});
                                                    
                                                    	Ext.getCmp('proj').getComponent(1).getComponent(0).getStore().reload();
                                                    	
                                                    	newProjectWindow.destroy();
                                                    	Ext.Ajax.request(
                                                        		{
                                                        	   url:'createRecord.action',
                                                        	   params : {	 
                                                   				   projectID : "" + jsProjectNumber + "",
                                                   			   },
                                                			   method:'post',
                                                			   success:function(){			
                                                				   Ext.getStore("listFile").reload();
                                                				 
                                                			   },
                                                        		failure: function(){
                                                        			
                                                        		}
                                                        		
                                                			   });
                                                    	
                                                    },  
                                                    //网络失败返回  
                                                    failure: function(form, action) {  
                                                       
                                                    }  
                                                }); 
                                            	
                                            	
          								    },
                                        },
                                        {
                                            xtype: 'button',
                                            text: '返回',
                                            handler: function(){
                                            	newProjectWindow.destroy();
          								    },
                                        }
                                     ]
                            	});
                            	
                            	var newProjectWindow = Ext.create('Ext.window.Window',{
                    	    		title: '创建项目窗口',
                    	    		width: 400,
                    	    		constrain: true,
                    	    		height: 300,
                    	    		layout: {
                    	    			type: 'fit',
                    	    		},
                 
                    	    		items: [
                    	    		                                        						 
                    	    		]
                    	    		 
                            	});
                            	newProjectWindow.add(newProjectForm);
                            	newProjectWindow.show();
                            }
                        }]
                    }]
                },
                
                
                
                {
                	xtype: 'container',
                    region: 'center',
                    id: 'calculateArea',
                    autoScroll: true,
                    layout: {
                        type: 'border'
                    },
                    title: '生成可复垦范围',
                    items: [
                        {
                            xtype: 'panel',
                            title: '需规划的底图',
                      
                            id: 'guihua',
                            listeners: {
    	                    	afterrender: {
    	                            fn: me.onAfterrender,
    	                            scope: me
    	                        },
    	           
    	                    },

                            region: "center",

                            html:  '<div id="guihuaMap" class="guihuaMapClass" style="width:100%;height:100%"></div>',
                        },
                        {
                        	
                            xtype: 'panel',
                  
                            title: '工具',
                            width: 200,
                            height: 100,
                            layout: {
                            	type: 'vbox'
                            },
                    
                            region: 'east',
                            collapsed: true,
                            collapsible: true,
                            items: [
                                {
                                	xtype: 'button',
                                	x: 1,
 	                                y: 160,
 	                                width: 70,
                                	text: '缩小',
                                	listeners: {
                                		click: {
                                			fn: me.onZoomOut,
                                			scope: me
                                		}
                                	}
                                }, 
                                {
                                	xtype: 'button',
                                	text: '放大',
                                	x: 1,
 	                                y: 160,
 	                                width: 70,
                                	listeners: {
                                		click: {
                                			fn: me.onZoomIn,
                                			scope: me
                                		}
                                	}
                                },
                                {
                                	xtype: 'button',
                                	text: '全范围显示',
                                	x: 1,
 	                                y: 160,
 	                                width: 70,
                                	listeners: {
                                		click: {
                                			fn: me.onExtent,
                                			scope: me
                                		}
                                	}
                                },
                                {
                                	xtype: 'button',
                                	text: '取消选择',
                                	x: 1,
 	                                y: 160,
 	                                width: 70,
                                	listeners: {
                                		click: {
                                			fn: me.onCancel,
                                			scope: me
                                		}
                                	}
                                },
                                {
                                	xtype: 'button',
                                	text: '规划复垦范围',
                                	x: 1,
 	                                y: 160,
 	                                width: 70,
                                	listeners: {
                                		click: {
                                			fn: me.onPlanning,
                                			scope: me
                                		}
                                	}
                                },
                            /*        
	                            {
	                                xtype: 'button',
	                                x: 1,
	                                y: 160,
	                                width: 70,
	                                text: '本地居民点文件(.shp)',
	                                listeners: {
	                                    click: {
	                                        fn: me.onLoadJMD,
	                                        scope: me
	                                    }
	                                }
	                            },
	                            {
	                                xtype: 'button',
	                                x: 1,
	                                y: 160,
	                                width: 70,
	                                text: '本地规划文件（.shp）',
	                                listeners: {
	                                    click: {
	                                        fn: me.onLoadGH,
	                                        scope: me
	                                    }
	                                }
	                            }
	                            */
	                        ],
	                        
	                        /*
                            html: '<div>' +
                            	'<form enctype="multipart/form-data" method="post" id="uploadForm1">'+
                                '<div class="field">'+
                                '<label class="file-upload">'+         
                                '<span><strong>上传底图<strong><span>' +
                                '<input type="file" name="file" id="inFile1" />'+
                                '</label>'+
                                '<span class="file-upload-status" style="opacity:1;" id="upload-status1"></span>'+
                  		  		'</div>' +
		                        '</form>' +
		                        '</div>' +
		                        '<div>' +
                            	'<form enctype="multipart/form-data" method="post" id="uploadForm2">'+
                                '<div class="field">'+
                                '<label class="file-upload">'+         
                                '<span><strong>上传叠加图层</strong></span>' +
                                '<input type="file" name="file" id="inFile2" />'+
                                '</label>'+
                                '<span class="file-upload-status" style="opacity:1;" id="upload-status2"></span>'+
                  		  		'</div>' +
		                        '</form>' +
		                        '</div>' +
		                        '<div style="border:1px solid #ccc;"><input type="button" style="background:#00ff00" value="叠加" onClick="jsOverlay()"></div>'
	                         */
                         
                     }

                    ]
                },
                {
                    xtype: 'form',
                    id: 'frmProjMng',
                    layout: 'absolute',
                    bodyPadding: 10,
                    title: '项目管理',
                    items: [
                        {
                            xtype: 'label',
                            x: 410,
                            y: 20,
                            style: {
                                fontSize: '24px',
                                fontFamily: '黑体'
                            },
                            text: '项 目 管 理'
                        },
                        {
                            xtype: 'textfield',
                            x: 100,
                            y: 100,
                            id: 'tfProjID',
                            width: 300,
                            fieldLabel: '项目编号',
                            labelWidth: 80,
                            readOnly: true
                        },
                        {
                            xtype: 'textfield',
                            x: 100,
                            y: 160,
                            id: 'tfProjLocation',
                            width: 300,
                            fieldLabel: '项目所在地',
                            labelWidth: 80,
                            readOnly: true
                        },
                        {
                            xtype: 'datefield',
                            x: 100,
                            y: 220,
                            id: 'dfProjTime',
                            width: 300,
                            fieldLabel: '创建时间',
                            labelWidth: 80,
                            format: 'Y/m/d'
                        },
                        {
                            xtype: 'datefield',
                            x: 100,
                            y: 280,
                            id: 'dfProjEndTime',
                            width: 300,
                            fieldLabel: '完成时间',
                            labelWidth: 80,
                            format: 'Y/m/d'
                        },
                        {
                            xtype: 'combobox',
                            x: 100,
                            y: 340,
                            id: 'cmbProjStatus',
                            width: 300,
                            fieldLabel: '项目阶段',
                            labelWidth: 80,
                            emptyText: '请按需改变项目阶段',
                            editable: false,
                            displayField: 'status',
                            store: new Ext.data.ArrayStore({
                            	fields: ['value', 'status'],
                            	data: [
                            	    [
					                    '1',
					                    '立项阶段'
					                ],
					                [
					                    '2',
					                    '规划阶段'
					                ],
					                [
					                    '3',
					                    '入库备案'
					                ],
					                [
					                    '4',
					                    '拆迁阶段'
					                ],
					                [
					                    '5',
					                    '项目完成'
					                ]
                            	],
                            }),
                            mode: 'local',
                            valueField: 'id'
                        },
                        {
                            xtype: 'button',
                            handler: function(button, e) {
                            	
                            	Ext.getCmp('proj').getLayout().setActiveItem(1);

                            },
                            x: 410,
                            y: 430,
                            height: 30,
                            id: 'btnProjMngOK',
                            width: 80,
                            text: '确定'
                        },
                        {
                            xtype: 'textareafield',
                            x: 450,
                            y: 100,
                            height: 262,
                            id: 'taProjDetails',
                            width: 500,
                            fieldLabel: '项目描述'
                        }
                    ]
                },
                {
                	xtype: 'panel',
                	title: '与现状冲突',
                	layout: 'fit',
                	items: [
                	    {
                	    	xtype: 'gridpanel',
                        	emptyText: '没有与现状冲突的地块',
                        	id: 'unfindCardPanel',
                	    	allowDeselect: true,
                            columnLines: true,
                            store: new Ext.data.ArrayStore({
                            	proxy:{
        			        		type:"ajax",
        			        		url:"showUnfindCard.action",
        			        		
        			        		reader:{
        			        			type:"json",
        			        			root:"results",
        			        			totalProperty :'totalCount'		
        			        		},
        			        		actionMethods: {  
        			                    read: 'POST'  
        			                },
        			        		writer:{
        			        			type:"json"
        			        		}
        			        	},
        			        	autoLoad: true,
        					    fields: [  	
        					          {name: 'id', type: 'auto'},
        					          {name: 'houseID', type: 'string'},
        					          {name: 'projectID', type: 'string'},
        					          {name: 'DYNHXM', type: 'string'},
        					          {name: 'housePhotoN', type: 'string'},
        					          {name: 'DYNHSFZ', type: 'string'},
        					          {name: 'warrantPhoto', type: 'string'},
        					          {name: 'XZDL', type: 'string'},
        					          {name: 'housePhotoY', type: 'string'},
        					          {name: 'comfire', type: 'string'}
        					    ], 
                            }),
                            columns: [		         									 
                                   {
                                	   xtype: 'gridcolumn',
                                       width: 75,
                                       align: 'center',
                                       dataIndex: 'projectID',
                                       text: '项目编号'        										  
                                   },
                                   {
                                	   xtype: 'gridcolumn',
                                       width: 75,
                                       align: 'center',
                                       dataIndex: 'houseID',
                                       text: '房屋编号'        										  
                                   },
                                   {
                                	   xtype: 'gridcolumn',
                                       width: 75,
                                       align: 'center',
                                       dataIndex: 'DYNHXM',
                                       text: '农户姓名'        										  
                                   },
                                   {
                                	   xtype: 'gridcolumn',
                                       width: 75,
                                       align: 'center',
                                       dataIndex: 'DYNHSFZ',
                                       text: '农户身份证'        										  
                                   },
                                   {
                                	   xtype: 'gridcolumn',
                                       width: 75,
                                       align: 'center',
                                       dataIndex: 'XZDL',
                                       text: '现状地类'        										  
                                   },
                                   {
                                	   xtype: 'gridcolumn',
                                       width: 75,
                                       align: 'center',
                                       dataIndex: 'comfire',
                                       text: '确认情况'        										  
                                   },	
                                   {
                                	   xtype: 'actioncolumn',
                                	   text: '查看权证照片',
                                	   align: 'center',
                                	   width: 75,
                                       items: [
                                            {
                                            	icon: 'img/check.png',  // Use a URL in the icon config
                                                tooltip: '权证照片',
                                            	handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                            		var path = "uploadPhoto/" + record.get('warrantPhoto');
                                            		
                                            		var imgBox = new Ext.Img({
                 		                            	height: 401,
                 	                                    width: 401,
                 		                            });
                 		                            
                                            		imgBox.setSrc(path);
                                            		var panel = Ext.create('Ext.panel.Panel', {
                                            			layout: 'fit',
                                            			item: []
                                            		});
                                            		panel.add(imgBox);
                                            		var win = Ext.create('Ext.window.Window', {
                                            			height: 401,
                 	                                    width: 401,
                 	                                    title: '权证照片'
                                            		});
                                            		win.add(panel);
                                            		win.show();
                                            	}
                                            }
                                       ]
                                   },
                                   {
                                	   xtype: 'actioncolumn',
                                	   text: '查看远景照片',
                                	   align: 'center',
                                	   width: 75,
                                       items: [
                                            {
                                            	icon: 'img/check.png',  // Use a URL in the icon config
                                                tooltip: '远景照片',
                                            	handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                            		var path = "uploadPhoto/" + record.get('housePhotoY');
                                            		
                                            		var imgBox = new Ext.Img({
                 		                            	height: 401,
                 	                                    width: 401,
                 		                            });
                 		                            
                                            		imgBox.setSrc(path);
                                            		var panel = Ext.create('Ext.panel.Panel', {
                                            			layout: 'fit',
                                            			item: []
                                            		});
                                            		panel.add(imgBox);
                                            		var win = Ext.create('Ext.window.Window', {
                                            			height: 401,
                 	                                    width: 401,
                 	                                    title: 'housePhotoY'
                                            		});
                                            		win.add(panel);
                                            		win.show();
                                            	}
                                            }
                                       ]
                                   },
                                   {
                                	   xtype: 'actioncolumn',
                                	   text: '查看近景照片',
                                	   align: 'center',
                                	   width: 75,
                                       items: [
                                            {
                                            	icon: 'img/check.png',  // Use a URL in the icon config
                                                tooltip: '近景照片',
                                            	handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                            		var path = "uploadPhoto/" + record.get('housePhotoN');
                                            		
                                            		var imgBox = new Ext.Img({
                 		                            	height: 401,
                 	                                    width: 401,
                 		                            });
                 		                            
                                            		imgBox.setSrc(path);
                                            		var panel = Ext.create('Ext.panel.Panel', {
                                            			layout: 'fit',
                                            			item: []
                                            		});
                                            		panel.add(imgBox);
                                            		var win = Ext.create('Ext.window.Window', {
                                            			height: 401,
                 	                                    width: 401,
                 	                                    title: '近景照片'
                                            		});
                                            		win.add(panel);
                                            		win.show();
                                            	}
                                            }
                                       ]
                                   },
                                   {
                                	   xtype: 'actioncolumn',
                                	   text: '确认信息',
                                	   align: 'center',
                                	   width: 75,
                                       items: [
                                            {
                                            	icon: 'img/check.png',  // Use a URL in the icon config
                                                tooltip: '确认信息',
                                            	handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                            		
                                            		Ext.Msg.confirm('提示', '确认所选的记录吗?', isOK);
                                                    function isOK(id){
        	                                            if (id == 'yes') {
        	                                            	var jsId = record.get('id');
        	                                            	Ext.Ajax.request({
        	                                        		
        	                                            		url: 'modifyUnfindCard.action',
        	                                        				
        	                                        			
        	                                        			params: {
    	                                        					id: "" + jsId + ""
    	                                        				},
        	                                        			method: 'post',
        	                                        			success: function(){
        	                                        				Ext.Msg.alert("提示", "确认成功");
        	                                        				Ext.getCmp('unfindCardPanel').getStore().reload();
        	                                        			},
        	                                        			failure: function(){
        	                                        				
        	                                        			}
        	                                        		});
        	                                            }
                                                    }
                                            		
                                            	}
                                            }
                                       ]
                                   },
                			],
                        }
                	]
                }
                	
            ]
        });

        me.callParent(arguments);
    },

    onAfterrender: function(){
        
  
    },
    onSubmitProjClick: function(button, e, eOpts) {

    },
    

    
    onCalculateAllClick: function(button, e, eOpts) {

    },

    onLoadJMD: function(button, e, eOpts) {
    	
    	jsAddDynamicLayer1();
    },
    
    //工具相关操作
    onZoomOut: function(button, e, eOpts) {
    	jsNavToolbar.activate(esri.toolbars.Navigation.ZOOM_OUT);
    	
    },
    
    onZoomIn: function(button, e, eOpts) {
    	
    	jsNavToolbar.activate(esri.toolbars.Navigation.ZOOM_IN);
    },
    onExtent: function(button, e, eOpts) {
    	
    	jsNavToolbar.zoomToFullExtent();
    },
    onCancel: function(button, e, eOpts) {
    	
    	jsNavToolbar.deactivate();
    },
    
    ///////////////////////
    //规划
    onPlanning: function(button, e, eOpts) {
    	jsNumberCard = 0;
    	var jsProjectID;
    	var jsProjectName;
    	var projectionStore = Ext.create('Ext.data.ArrayStore', {
    		proxy:{
        		type:"ajax",
        		url:"showProject.action",
        		
        		reader:{
        			type:"json",
        			root:"results",
        			totalProperty :'totalCount'		
        		},
        		actionMethods: {  
                    read: 'POST'  
                },
        		writer:{
        			type:"json"
        		}
        	},
		    fields: [  	
		          {name: 'id', type: 'auto'},
		          {name: 'projectNumber', type: 'string'},
		          {name: 'projectAddress', type: 'string'},
		          {name: 'createTime', type: 'date'},
		          {name: 'projectStatus', type: 'string'},
		          {name: 'endTime', type: 'date'},
		          {name: 'projectDescription', type: 'string'},
		    ],  
		      
		});  
    	projectionStore.load();
	    var projectionPanel = Ext.create('Ext.grid.Panel', { 								    	  
	    	emptyText: '没有项目可选择',
	    	region: 'center',
	    	allowDeselect: true,
            columnLines: true,
            store: projectionStore,
            columns: [		         									 
                   {
                	   xtype: 'gridcolumn',
                       width: 75,
                       align: 'center',
                       dataIndex: 'projectNumber',
                       text: '项目编号'        										  
                   },
				   {
                	   xtype: 'gridcolumn',
	                   width: 150,
	                   align: 'center',
	                   dataIndex: 'projectAddress',
	                   text: '项目所在地'        										  
				   },
				   {
					   xtype: 'datecolumn',
	                   width: 75,
	                   align: 'center',
	                   dataIndex: 'createTime',
	                   text: '立项时间'        										  
				   },
				   {
					   xtype: 'gridcolumn',
	                   width: 150,
	                   align: 'center',
	                   dataIndex: 'projectDescription',
	                    
	                   text: '项目描述'        										  
				   },
							 
			],
				 
			selModel: Ext.create('Ext.selection.CheckboxModel', {
			    	
            }) 
	    });
	    var projectionWindow = Ext.create('Ext.window.Window',{
    		title: '请选择项目',
    		width: 600,
    		
    		height: 400,
    		layout: {
    			type: 'border',
    		},
    		items: [
				 {
					 xtype: 'panel',	
					 layout: 'hbox',
					 region: 'south',
					 items: [
						  {
							  
							  xtype: 'button',
							  text: '确定',
							  handler: function(){
								  if (projectionPanel.getSelectionModel().hasSelection()) {
									  var records = projectionPanel.getSelectionModel().getSelection();
									  jsProjectID = records[0].get('projectNumber');
									  jsProjectName = records[0].get('projectAddress');
									  projectionWindow.destroy();
									  var planWindow = Ext.create('Ext.window.Window',{
								    		title: '规划向导窗口',
								    		id: 'planWindow',
								    		width: 400,
								    		height: 600,
								    		layout: {
								    			type: 'border',
								    		},
								    		items: [
								    		     {
								    		    	 xtype: 'container',
								                     region: 'center',
								                     id: 'planWizard',
								                     
								                     
								                     layout: {
								                    	 type: 'card',
								                     },
								                     items: [
								                          {
								                        	  xtype: 'panel',
								                        	  title: '规划向导首页',
								                        	  layout: {
								                        		  type: 'border',
								                        	  },
								                          	  items: [
								                          	       {
								                          	    	   xtype: 'text',
								                          	    	   text: '      欢迎使用规划向导！\r\n' +
								                          	    		  '本系统规划过程分为以下五个步骤：\r\n' + 
								                          	    		  '    1.选择项目所涉及位置。\r\n' + 
								                          	    		  '    2.叠加二调现状数据，以确定可以规划区域。\r\n' +
								                          	    		  '    3.叠加土地利用总体规划，选出可复垦区域。\r\n' +
								                          	    		  '    4.人工操作，去除特殊情况。\r\n' +
								                          	    		  '    5.保存最终结果。\r\n',
								                          	       }
								                          	  ]
								                          },
								                          {
								                        	  xtype: 'panel',
								                        	  title: '选择项目所涉及位置',
								                        	  id: 'SelectCard',
								                        	  layout: {
								                                  type: 'fit'
								                              },
								                        	  items: [	  
																   
								                        	  ]
								                          },
								                          {
								                        	  xtype: 'panel',
								                        	  title: '叠加现状数据',
								                        	  id: 'XZSJ',
								                        	  layout: {
								                        		  type: 'fit',
								                        	  },
								                          	  items: [
																   {									   
																	   xtype: 'text',
																	   text: '  点击下一步叠加现状数据！\r\n' +
																		  '叠加结果中可能会有不符合现状数据的地块，在图中用红色标识，\r\n' +
																		  '并且地块属性将在弹出的列表中进行显示，请选择能够提供证明\r\n' +
																		  '的地块点击确定。'
																								   
																   }  
								                          	  ]
								                          },
								                          {
								                        	  xtype: 'panel',
								                        	  title: '叠加规划数据',
								                        	  id: 'GHSJ',
								                        	  layout: {
								                        		  type: 'fit',
								                        	  },
								                          	  items: [
																   {											
																	   xtype: 'text',
																	   text: '  点击下一步叠加规划数据！\r\n' +
																	   	  '规划规则：依据规划地类属性，选取耕地、园地、林地、牧草地、\r\n' +  
																	      '农村居民点五种地类。\r\n' +  
																	      '叠加结果中可能会有不符合规划规则的地块，在图中用红色标识，\r\n' +
																		  '不符合规划规则的地块无法用于复垦，将被自动剔除！'						   
																   } 
								                          	  ]
								                          },
								                          {
								                        	  xtype: 'panel',
								                        	  title: '选择参与复垦的宅基地',
								                        	  id: 'finalSelect',
								                        	  layout: {
								                                  type: 'fit'
								                              },
								                        	  items: [	  
																   
								                        	  ]
								                          },
								                     ]
								    		    	 
								    		     },
								    		     {
								    		    	 xtype: 'panel',
								    		    	 
								    		    	 region: 'south',
								    		    	 items: [
//								    		    	      {
//								    		    	    	  xtype: 'button',
//								    		    	    	  text: '上一步',
//								    		    	    	  id: 'pPrev',
//								    		    	    	  hide: true,
//								    		    	    	  width: 70,
//								    		    	    	  listener: {
//								    		    	    		  click: {
//								    		    	    	//		  fn: me.onPrev,
//								    		    	    	//		  scope: me
//								    		    	    		  }
//								    		    	    	  }
//								    		    	      },
								    		    	      {
								    		    	    	  xtype: 'button',
								    		    	    	  text: '下一步',
								    		    	    	  id: 'pNext',
								    		    	    	  width: 70,
								    		    	    	  handler: function(button, e, eOpts) {    		    	    		  
								    		    	    		  
									    	    				  var cards = Ext.getCmp('planWizard').getLayout();
									    	    				 
									    	    				  switch (jsNumberCard) {	    	    				  
																  case 0:
																	  jsSelectJMD();
																	  msgTip = Ext.MessageBox.show({
													            	    	title:'提示',
													            	    	width : 250,
													            	    	msg:'加载中,请稍后......',
													            	    	progress:true,  
													            	    	closable:false,  
													            	    	
													            	    			
									    		    	    		  }); 
																	  
																	  jsNumberCard = 1;	
																	  msgTip.on('hide',function(){ 										  
																		if (jsNumberCard != 1) {
																			return;
																		}							
																		
										            	    			var tempStore = Ext.create('Ext.data.ArrayStore', {
																	    	  
																		      fields: [  	
																		          {name: 'Id'},
																		          {name: 'QSDWDM'},  
																		          {name: 'QSDWMC'},  
																		          {name: 'DYNHXM'},  
																		          {name: 'DYNHSFZ'},
																		          {name: 'Shape_Area'},
																		          {name: 'FWJG'},
																		          {name: 'FWSYSJ'}
																		      ],  
																		      data: resultItems//对应上面代码  
																		  });  
																	      var tempPanel = Ext.create('Ext.grid.Panel', { 								    	  
																	    	  emptyText: '没有居民点数据',
										                        	    	  id: 'selectedC',
										                        	    	  
										                        	    	  allowDeselect: true,
										                                      columnLines: true,
										                                      store: tempStore,
										                                      columns: [		         									 
										         									 {
										         										 xtype: 'gridcolumn',
										                                                 width: 150,
										                                                 align: 'center',
										                                                 dataIndex: 'QSDWDM',
										                                                 text: '权属单位代码'        										  
										         									 },
										         									 {
										         										 xtype: 'gridcolumn',
										                                                 width: 75,
										                                                 align: 'center',
										                                                 dataIndex: 'QSDWMC',
										                                                 text: '权属单位名称'        										  
										         									 },
										         									 {
										         										 xtype: 'gridcolumn',
										                                                 width: 75,
										                                                 align: 'center',
										                                                 dataIndex: 'DYNHXM',
										                                                 text: '户主姓名'        										  
										         									 },
										         									 {
										         										 xtype: 'gridcolumn',
										                                                 width: 150,
										                                                 align: 'center',
										                                                 dataIndex: 'DYNHSFZ',
										                                                 text: '户主身份证号'        										  
										         									 },
										         									 {
										         										 xtype: 'gridcolumn',
										                                                 width: 150,
										                                                 align: 'center',
										                                                 dataIndex: 'Shape_Area',
										                                                 text: '地块面积'        										  
										         									 },
										         									 {
										         										 xtype: 'gridcolumn',
										                                                 width: 150,
										                                                 align: 'center',
										                                                 dataIndex: 'FWJG',
										                                                 text: '房屋结构'        										  
										         									 },
										         									 {
										         										 xtype: 'gridcolumn',
										                                                 width: 150,
										                                                 align: 'center',
										                                                 dataIndex: 'FWSYSJ',
										                                                 text: '房屋使用时间（年）'        										  
										         									 },
										         							   ],
										         							   selModel: Ext.create('Ext.selection.CheckboxModel', {

										                                       }) 
										                        	      });
																	      
																	      Ext.getCmp("SelectCard").add(tempPanel);
																	      
																		  jsNumberCard = 1;									  
																		  Ext.getCmp('planWizard').getLayout().setActiveItem(jsNumberCard);
																		  //cards.next();	
										           					  });
																	  break;
																  case 1:
																	  if (Ext.getCmp("selectedC").getSelectionModel().hasSelection()){
																		  var records=Ext.getCmp("selectedC").getSelectionModel().getSelection();
																		  var jsSql = "";

																		  for(var i=0;i<records.length;i++){
																			  
																			  var id = records[i].get("Id");
																			  if (i ==  records.length - 1) {
																				  jsSql = jsSql + "\"Id\" = " +	id;
																				  continue;
																			  }
																			  jsSql = jsSql + "\"Id\" = " +	id + " OR ";										 
																		  }
																		  jsSelect(jsSql);
																		  msgSel = Ext.MessageBox.show({
														            	    	title:'提示',
														            	    	width : 250,
														            	    	msg:'正在筛选居民点,请稍后......',
														            	    	progress:true,  
														            	    	closable:false,  
														            	    	
														            	    			
										    		    	    		  }); 
																		  
																		  jsNumberCard = 2;	
																		  msgSel.on('hide',function(){ 
																			  if (jsNumberCard != 2) {
																				  return;
																			  }
																			  jsNumberCard = 2;	
																			  
																			  Ext.getCmp('planWizard').getLayout().setActiveItem(2);
																		  });
																	  }else{
																		  Ext.Msg.alert("警告!" ,"至少选择一个居民点！");
																	  }								  
																	  
																	  break;
																  case 2:
																	  jsOverlay("XZSJ");
																	  msgOver= Ext.MessageBox.show({
													            	    	title:'提示',
													            	    	width : 250,
													            	    	msg:'正在叠加现状数据,请稍后......',
													            	    	progress:true,  
													            	    	closable:false,  
													            	    	
													            	    			
									    		    	    		  }); 
																	  msgOver.on('hide',function(){ 
																		  
																		  if (jsNumberCard != 2) {
																			  return;
																		  }
																	
																		  var unFindStore = Ext.create('Ext.data.ArrayStore', {
																	    	  
																		      fields: [  	
																		          {name: 'Id'},
																		          {name: 'QSDWDM'},  
																		          {name: 'QSDWMC'},  
																		          {name: 'DYNHXM'},  
																		          {name: 'DYNHSFZ'},
																		          {name: 'Shape_Area'},
																		          {name: 'DLMC'},
																		          {name: 'FID'}
																		      ],  
																		      data: resultItems1//对应上面代码  
																		  });  
																	      var unFindPanel = Ext.create('Ext.grid.Panel', { 								    	  
																	    	  emptyText: '没有居民点数据',
										                        	    	  id: 'unFindJMD',
										                        	    	  region: 'center',
										                        	    	  allowDeselect: true,
										                                      columnLines: true,
										                                      store: unFindStore,
										                                      columns: [		         									 
										         									 {
										         										 xtype: 'gridcolumn',
										                                                 width: 150,
										                                                 align: 'center',
										                                                 dataIndex: 'QSDWDM',
										                                                 text: '权属单位代码'        										  
										         									 },
										         									 {
										         										 xtype: 'gridcolumn',
										                                                 width: 75,
										                                                 align: 'center',
										                                                 dataIndex: 'QSDWMC',
										                                                 text: '权属单位名称'        										  
										         									 },
										         									 {
										         										 xtype: 'gridcolumn',
										                                                 width: 150,
										                                                 align: 'center',
										                                                 dataIndex: 'DLMC',
										                                                 text: '现状地类'        										  
										         									 },
										         									 {
										         										 xtype: 'gridcolumn',
										                                                 width: 75,
										                                                 align: 'center',
										                                                 dataIndex: 'DYNHXM',
										                                                 text: '户主姓名'        										  
										         									 },
										         									 {
										         										 xtype: 'gridcolumn',
										                                                 width: 150,
										                                                 align: 'center',
										                                                 dataIndex: 'DYNHSFZ',
										                                                 text: '户主身份证号'        										  
										         									 },		         									 
										         									 {
										         										 xtype: 'gridcolumn',
										                                                 width: 150,
										                                                 align: 'center',
										                                                 dataIndex: 'Shape_Area',
										                                                 text: '地块面积'        										  
										         									 },
										         									 
										         							   ],
										         							   selModel: Ext.create('Ext.selection.CheckboxModel', {

										                                       }) 
										                        	      });
																	      var unFindWindow = Ext.create('Ext.window.Window',{
																	    		title: '不符合现状数据的地块',
																	    		width: 600,
																	    		
																	    		height: 600,
																	    		layout: {
																	    			type: 'border',
																	    		},
																	    		items: [
																					 {
																						 xtype: 'panel',														 
																						 region: 'south',
																						 items: [
																							  {
																								  
																								  xtype: 'button',
																								  text: '确定并下发任务',
																								  id: 'unFindButton',
																								
																								  width: 70,
																								  
																							  },
																						 ]
																					 }
																						 
																	    		]
																	    		 
																	      });
																	      if (jsNumberCard == 2) {
																	    	 
																	    	  unFindWindow.show();
																		      unFindWindow.add(unFindPanel);
																		  }
																	      
																	  
																	      Ext.getCmp('unFindButton').on('click', function(button, e, eOpts) {    
																			 
																			  if (Ext.getCmp("unFindJMD").getSelectionModel().hasSelection()){
																				  var records=Ext.getCmp("unFindJMD").getSelectionModel().getSelection();
																				  var jsDYNHXM = ""
																				  var jsDYNHSFZ = "";
																				  
																				  var houseID = "";
																				  var jsXZDL = "";
																				  var jsUpdateAttributes = [];
																				  for (var i = 0; i < records.length; i++) {
																					  jsDYNHXM = jsDYNHXM + records[i].get("DYNHXM") + ",";
																					  jsDYNHSFZ = jsDYNHSFZ + records[i].get("DYNHSFZ") + ",";
																					
																					  jsXZDL = jsXZDL + records[i].get("DLMC") + ",";
																					 
																					  
																					  houseID = houseID + records[i].get("Id") + ","; 	
																					  var voteRecord = {							  
																					          attributes: {							        	  
																					              "Id": records[i].get("Id"),
																					              "DLMC": '村庄',
																					              "SFDYXZSJ": records[i].get("DLMC"),
																					          }
																					      };
																					  	  
																					  jsUpdateAttributes.push(voteRecord);
																				  }
																				  jsDYNHXM = jsDYNHXM.substring(0, jsDYNHXM.length-1);
																				  jsDYNHSFZ = jsDYNHSFZ.substring(0, jsDYNHSFZ.length-1);
																				 
																				  jsXZDL = jsXZDL.substring(0, jsXZDL.length-1);
																				  var jsHouseID = houseID.substring(0, houseID.length - 1);
																				  houseID = "编号为：" + jsHouseID + "的房屋需要调查！";
																				  
																				  Ext.Ajax.request({											  
												                                        //设置提交的地址  
												                                        url:'addUnfindCard.action',  
												                                        //设置提交的方式为post  
												                                        
												                                        params : {
												                            				houseID: "" + jsHouseID + "",
												                            				
												                            				DYNHXM: "" + jsDYNHXM + "",
												                            				DYNHSFZ: "" + jsDYNHSFZ + "",
												                            				
												                            				XZDL: "" + jsXZDL + "",
												                          				
												                            				projectID: "" + jsProjectID + ""
												                            			},
												                                        method: 'post',  
												                                        success: function(){
												                                        	Ext.getCmp('unfindCardPanel').getStore().reload();
												                                        }
												                                  }); 
																				  
																				  var raskWindow = Ext.create('Ext.window.Window',{
															                    		width: 830,
															                    	    layout: {
															                    	        type: 'fit'
															                    	    },
															                    	    title: '新增任务',
														                    	    		
													                    	    		constrain: true,
													                    	    		items: [				                    	    		     
																							{
																							    xtype: 'form',
																							    height: 500,														 
																							    layout: {
																							        type: 'absolute'
																							    },
																
																							    bodyPadding: 10,
																	
																							    items: [
																							        {
																							            xtype: 'textfield',
																							        
																							            width: 670,
																							            fieldLabel: '任务编号',
																							            labelWidth: 80,
																							            
														
																							        },
																							        {
																							            xtype: 'textfield',
																							            x: 10,
																							            y: 40,
																							            width: 780,
																							            fieldLabel: '项目名称',
																							            labelWidth: 80,
																							            value: jsProjectName
																							            
																							        },
																							        {
																							            xtype: 'textfield',
																							            x: 10,
																							            y: 70,
																							            width: 780,
																							            fieldLabel: '项目编号',
																							            labelWidth: 80,
																							            value: jsProjectID
																							        },
																							        {
																							            xtype: 'combobox',
																							            x: 10,
																							            y: 100,
																							            width: 780,
																							            fieldLabel: '任务类型',
																							            labelWidth: 80,
																							         
																							            store: new Ext.data.ArrayStore({
									    	                                                            	fields: ['value', 'text'],
									    	                                                            	data: [
									    	                                                            	    ['1', '规划监测'],
									    	                                                                                                            	   
									    	                                                            	],
									    	                                                            }),
									    	                                                            mode: 'local',
									    	                                                            valueField: 'value',
									    	                                                            editable: false,
									    	                                                            displayField: 'text',           	           
									    	                                                            value: '1'
																							        },
																							        {
																							            xtype: 'textfield',
																							            x: 10,
																							            y: 130,
																							            width: 780,
																							            fieldLabel: '任务下达人',
																							            labelWidth: 80,
																							            name: 'rwResponsiblePerson'
																							        },
																							        {
																							            xtype: 'datefield',
																							            x: 10,
																							            y: 170,
																							            width: 780,
																							            fieldLabel: '任务执行时间',
																							            labelWidth: 80,
																							            name: 'rwStarttime',
																							            format: 'Y-m-d'
																							        },
																							        {
																							            xtype: 'datefield',
																							            x: 10,
																							            y: 200,
																							            width: 780,
																							            fieldLabel: '任务截止时间',
																							            labelWidth: 80,
																							            name: 'rwEndtime',
																							            format: 'Y-m-d'
																							        },
																							        {
																							            xtype: 'textareafield',
																							            x: 10,
																							            y: 240,
																							            height: 180,
																							            width: 780,
																							            fieldLabel: '任务描述',
																							            labelWidth: 80,
																							            value: houseID
																							        },
																							        {
																							            xtype: 'button',
																							            handler: function(button, event) {
																							                var form = this.up('form').getForm(); // get the basic form
																							                var raskForm = raskWindow.getComponent(0);
																							
																							                if (form.isValid()) { // make sure the form contains valid data before submitting
																							                    form.submit({
																							                        url:'addRask.action', 
																							                        params: {
																							                        	rwId : "" + raskForm.getComponent(0).getValue() + "",
																							                        	projectName: "" + raskForm.getComponent(1).getValue() + "",
																							                        	projectId: "" + raskForm.getComponent(2).getValue() + "",
																							                        	rwResponsiblePerson: "" + raskForm.getComponent(4).getValue() + "",
																							                        	rwClass: "" + raskForm.getComponent(3).getRawValue() + "",														                        	
																							                        	rwStarttime: "" + Ext.util.Format.date(raskForm.getComponent(5).getValue(), "Y-m-d") + "",
																							                        	rwEndtime: "" + Ext.util.Format.date(raskForm.getComponent(6).getValue(), "Y-m-d") + "",														                        	
																							                        	rwContent: "" + raskForm.getComponent(7).getRawValue() + ""
																							                     
																							                        },
																							                        method: 'post',  
																							                        success: function(form, action) {
							
																							                            var mystore = Ext.StoreMgr.get('raskStore'); //获得store对象                                                   
																							                            mystore.load();  
																							                            			
																							                            raskWindow.close();

																														jsEditFeature(jsUpdateAttributes[0]);
																														unFindWindow.close();
																														  
																														msgEdit= Ext.MessageBox.show({
																															
																															title:'提示',
																										            	    width : 250,
																										            	    msg:'正在修改地类属性,请稍后......',
																										            	    progress:true,  
																										             			
																						    		    	    		}); 
																												
																														jsNumberCard = 3;	
																														msgEdit.on('hide',function(){ 
																															if (jsNumberCard != 3) {
																																return;
																															}
																															jsNumberCard = 3;	
																															Ext.getCmp('planWizard').getLayout().setActiveItem(3);
																															
																														});
																							                        },
																							                        failure: function(form, action) {
																							                            Ext.Msg.alert('失败', '提交失败');
																							                        }
																							                    });
																							                } else { // display error alert if the data is invalid
																							                Ext.Msg.alert('Invalid Data', 'Please correct form errors.');}
																							            },
																							            x: 230,
																							            y: 440,
																							            width: 100,
																							            text: '确定'
																							        },
																							        {
																							            xtype: 'button',
																							            handler: function(button, event) {
																							            	raskWindow.close();
																							            },
																							            x: 520,
																							            y: 440,
																							            height: 20,
																							            width: 90,
																							            text: '取消'
																							        },
																							        {
																							            xtype: 'button',
																							            handler: function(button, event) {
																							
																							                Date.prototype.format = function(format){ 
																							                    var o = { 
																							                        "M+" : this.getMonth()+1, //month 
																							                        "d+" : this.getDate(), //day 
																							                        "h+" : this.getHours(), //hour 
																							                        "m+" : this.getMinutes(), //minute 
																							                        "s+" : this.getSeconds(), //second 
																							                        "q+" : Math.floor((this.getMonth()+3)/3), //quarter 
																							                        "S" : this.getMilliseconds() //millisecond 
																							                    }; 
																							                    if(/(y+)/.test(format)) { 
																							                        format = format.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length)); 
																							                    } 
																							                    for(var k in o) { 
																							                        if(new RegExp("("+ k +")").test(format)) { 
																							                            format = format.replace(RegExp.$1, RegExp.$1.length==1 ? o[k] : ("00"+ o[k]).substr((""+ o[k]).length)); 
																							                        } 
																							                    } 
																							                    return format; 
																							                }; 
																							
																							
																							                var newDate = new Date();//日历实例化
																							                var raskForm = raskWindow.getComponent(0);
																							                var newRwId;
																							                if (raskForm.getComponent(3).getValue() == '1') {
																							                	newRwId = "GHJC"+newDate.format("yyyyMMddhhmmss");//当前日期格式化	
																											}else{
																												newRwId = "CQJC"+newDate.format("yyyyMMddhhmmss");//当前日期格式化	
																											}
																							                
																							                raskForm.getComponent(0).setValue(newRwId);
																							            },
																							            x: 700,
																							            y: 10,
																							            text: '生成任务编号'
																							        }
																							    ]
																							},
													                    						 
													                    	    		]
													                    	    		 
													                    	        });
														                    	    
														                    	    raskWindow.show();
																				  
																				  
																			  }
																		  });						
																	      																	  
																		  
																	  });
																	  
																	  break;
																  case 3:
																	  jsOverlay("GHSJ");
																	  jsFlag = "GHSJ";
																	  msgOver= Ext.MessageBox.show({
													            	    	title:'提示',
													            	    	width : 250,
													            	    	msg:'正在叠加规划数据,请稍后......',
													            	    	progress:true,  
													            	    	closable:false,  
													            	    	
													            	    			
									    		    	    		  }); 
																	  msgOver.on('hide',function(){ 
																		  if (jsNumberCard != 3) {
																			  return;
																		  }
																		  
																		  var unCheckStore = Ext.create('Ext.data.ArrayStore', {
																	    	  
																		      fields: [  	
																		          {name: 'Id'},
																		          {name: 'QSDWDM'},  
																		          {name: 'QSDWMC'},  
																		          {name: 'DYNHXM'},  
																		          {name: 'DYNHSFZ'},
																		          {name: 'Shape_Area'},
																		          {name: 'GHDLMC'},
																		          {name: 'FID'}
																		      ],  
																		      data: resultItems2//对应上面代码  
																		  });  
																	      var unCheckPanel = Ext.create('Ext.grid.Panel', { 								    	  
																	    	  emptyText: '没有不符合规划的居民点。',
										                        	    	  id: 'unFindJMD',
										                        	    	  region: 'center',
										                        	    	  allowDeselect: true,
										                                      columnLines: true,
										                                      store: unCheckStore,
										                                      columns: [		         									 
										         									 {
										         										 xtype: 'gridcolumn',
										                                                 width: 150,
										                                                 align: 'center',
										                                                 dataIndex: 'QSDWDM',
										                                                 text: '权属单位代码'        										  
										         									 },
										         									 {
										         										 xtype: 'gridcolumn',
										                                                 width: 75,
										                                                 align: 'center',
										                                                 dataIndex: 'QSDWMC',
										                                                 text: '权属单位名称'        										  
										         									 },
										         									 {
										         										 xtype: 'gridcolumn',
										                                                 width: 150,
										                                                 align: 'center',
										                                                 dataIndex: 'GHDLMC',
										                                                 text: '规划地类'        										  
										         									 },
										         									 {
										         										 xtype: 'gridcolumn',
										                                                 width: 75,
										                                                 align: 'center',
										                                                 dataIndex: 'DYNHXM',
										                                                 text: '户主姓名'        										  
										         									 },
										         									 {
										         										 xtype: 'gridcolumn',
										                                                 width: 150,
										                                                 align: 'center',
										                                                 dataIndex: 'DYNHSFZ',
										                                                 text: '户主身份证号'        										  
										         									 },		         									 
										         									 {
										         										 xtype: 'gridcolumn',
										                                                 width: 150,
										                                                 align: 'center',
										                                                 dataIndex: 'Shape_Area',
										                                                 text: '地块面积'        										  
										         									 },
										         									 
										         							   ],
										         							   
										                        	      });
																	      var unCheckWindow = Ext.create('Ext.window.Window',{
																	    		title: '不符合规划的地块',
																	    		width: 600,
																	    
																	    		height: 600,
																	    		layout: {
																	    			type: 'border',
																	    		},
																	    		items: [
																					 {
																						 xtype: 'panel',														 
																						 region: 'south',
																						 items: [
																							  {
																								  
																								  xtype: 'button',
																								  text: '确定',
																								  id: 'unCheckButton',
																								
																								  width: 70,
																								  
																							  },
																						 ]
																					 }
																						 
																	    		]
																	    		 
																	      });
																	      if (jsNumberCard == 3) {
																		    	 
																	    	  unCheckWindow.show();
																	    	  unCheckWindow.add(unCheckPanel);
																		  }
																	      
																	      Ext.getCmp('unCheckButton').on('click', function(button, e, eOpts) {    
																	    	  var jsSql = "";
																	    	  unCheckStore.each(function(record) {  
																				  var id = record.get("Id");				
																				  jsSql = jsSql + "\"Id\" <> " +	id + " AND ";										 
											  									    	  
																	    	  });
																	    	  
																	    	  comfireJMD = function(){ 
																	    		  if (jsNumberCard != 4) {
																					  return;
																				  }
																				
																				  var cardPieces = [];
																				  
																				  for ( var i = 0; i < jsFJMD.graphics.length; i++) {
																					  
																					  var g = jsFJMD.graphics[i];
																					  var attributes = g.attributes;
																					  cardPieces.push([										                   
																					       attributes.Id, attributes.QSDWMC,
																					       attributes.DYNHXM, attributes.DYNHSFZ,
																					       attributes.Shape_Area, attributes.FWJG,
																					       attributes.FWSYSJ, attributes.DLMC,
																					       attributes.SFDYXZSJ, attributes.FWZP
																					  ]);
																					 
																				  }
																				  
																				  var cardStore = Ext.create('Ext.data.ArrayStore', {
																			    	  
																				      fields: [  	
																				          {name: 'Id'},
																				          {name: 'QSDWMC'},  
																				          {name: 'DYNHXM'},  
																				          {name: 'DYNHSFZ'},
																				          {name: 'Shape_Area'},
																				          {name: 'FWJG'},
																				          {name: 'FWSYSJ'},
																				          {name: 'DLMC'},
																				          {name: 'SFDYXZSJ'},
																				          {name: 'FWZP'},
																				          
																				      ],  
																				      data: cardPieces//对应上面代码  
																				  });  
																			      var cardPanel = Ext.create('Ext.grid.Panel', { 								    	  
																			    	  emptyText: '没有可参与复垦的居民点',
												                        	    	  id: 'cardPiece',
												                        	    	  
												                        	    	  allowDeselect: true,
												                                      columnLines: true,
												                                      store: cardStore,
												                                      columns: [		         									 
												         									 
												         									 {
												         										 xtype: 'gridcolumn',
												                                                 width: 75,
												                                                 align: 'center',
												                                                 dataIndex: 'QSDWMC',
												                                                 text: '权属单位名称'        										  
												         									 },
												         									 {
												         										 xtype: 'gridcolumn',
												                                                 width: 75,
												                                                 align: 'center',
												                                                 dataIndex: 'DYNHXM',
												                                                 text: '户主姓名'        										  
												         									 },
												         									 {
												         										 xtype: 'gridcolumn',
												                                                 width: 150,
												                                                 align: 'center',
												                                                 dataIndex: 'DYNHSFZ',
												                                                 text: '户主身份证号'        										  
												         									 },
												         									 {
												         										 xtype: 'gridcolumn',
												                                                 width: 150,
												                                                 align: 'center',
												                                                 dataIndex: 'Shape_Area',
												                                                 text: '地块面积'        										  
												         									 },
												         									 {
												         										 xtype: 'gridcolumn',
												                                                 width: 150,
												                                                 align: 'center',
												                                                 dataIndex: 'FWJG',
												                                                 text: '房屋结构'        										  
												         									 },
												         									 {
												         										 xtype: 'gridcolumn',
												                                                 width: 150,
												                                                 align: 'center',
												                                                 dataIndex: 'FWSYSJ',
												                                                 text: '房屋使用时间（年）'        										  
												         									 },
												         									 {
												         										 xtype: 'gridcolumn',
												                                                 width: 150,
												                                                 align: 'center',
												                                                 dataIndex: 'DLMC',
												                                                 text: '地类名称（修改后）'        										  
												         									 },
												         									 {
												         										 xtype: 'gridcolumn',
												                                                 width: 150,
												                                                 align: 'center',
												                                                 dataIndex: 'SFDYXZSJ',
												                                                 text: '地类名称（修改前）'        										  
												         									 },
												         							   ],
												         							   selModel: Ext.create('Ext.selection.CheckboxModel', {

												                                       }) 
												                        	      });
																			      
																			      Ext.getCmp("finalSelect").add(cardPanel);
																			      Ext.getCmp('pNext').text = '保存结果并完成';
																			      Ext.getCmp('planWizard').getLayout().setActiveItem(4);
																			  };
																	    	  	
																	    	  
																	    	  
																	    	  if (jsSql != "") {
																	    		  jsSql = jsSql.substring(0, jsSql.length - 5);
																	    		  alert(jsSql);
																	    		  jsSelectCommon(jsSql, "");
																	    		  msgEdit = Ext.MessageBox.show({
																            	    	title:'提示',
																            	    	width : 250,
																            	    	msg:'正在剔除不符合规划的数据,请稍后......',
																            	    	progress:true,  
																            	    	closable:false, 			
												    		    	    		  }); 
																	    		  unCheckWindow.close();
																		    	  jsNumberCard = 4;
																		    	  msgEdit.on('hide', comfireJMD);
																	    	  }else{
																	    		
																	    		  msgEdit = Ext.MessageBox.show({
																            	    	title:'提示',
																            	    	width : 250,
																            	    	msg:'正在剔除不符合规划的数据,请稍后......',
																            	    	progress:true,  
																            	    	closable:false, 			
												    		    	    		  }); 
																	    		  unCheckWindow.close();
																		    	  jsNumberCard = 4;
																		    	 
																		    	  msgEdit.on('hide', comfireJMD); 
																	    		  msgEdit.hide();
																	    		  
																	    	  }
												    	  
																	    	  
																	    	  
																	      });			  
																	  });
																	  break;
																	  
																  case 4:
																	  if (Ext.getCmp("cardPiece").getSelectionModel().hasSelection()){
																		  var records=Ext.getCmp("cardPiece").getSelectionModel().getSelection();
																		  var jsSql = "";

																		  var jsHouseNumber = "";
																		  var jsQSDWMC = "";
																		  var jsDYNHXM = "";
								                          				  var jsDYNHSFZ = "";
								                          				  var jsShape_Area = "";
								                          				  var jsFWJG = "";
								                          				  var jsFWSYSJ = "";
								                          				  var jsDLMC = "";
								                          				  var jsSFDYXZSJ = "";
								                          				  var jsFWZP = "";
																		  
																		  for(var i=0;i<records.length;i++){
																			  
																			  var id = records[i].get("Id");
																			  
																			  if (i ==  records.length - 1) {
																				  jsSql = jsSql + "\"Id\" = " +	id;
																				  jsHouseNumber += id;
																				  jsQSDWMC += records[i].get("QSDWMC");
																				  jsDYNHXM += records[i].get("DYNHXM");
																				  jsDYNHSFZ += records[i].get("DYNHSFZ");
																				  jsShape_Area += records[i].get("Shape_Area");
																				  jsFWJG += records[i].get("FWJG");
																				  jsFWSYSJ += records[i].get("FWSYSJ");
																				  jsDLMC += records[i].get("DLMC");
																				  jsSFDYXZSJ += records[i].get("SFDYXZSJ");
																				  jsFWZP += records[i].get("FWZP");
																				  continue;
																			  }
																			  
																			  jsHouseNumber += id + ",";
																			  jsQSDWMC += records[i].get("QSDWMC") + ",";
																			  jsDYNHXM += records[i].get("DYNHXM") + ",";
																			  jsDYNHSFZ += records[i].get("DYNHSFZ") + ",";
																			  jsShape_Area += records[i].get("Shape_Area") + ",";
																			  jsFWJG += records[i].get("FWJG") + ",";
																			  jsFWSYSJ += records[i].get("FWSYSJ") + ",";
																			  jsDLMC += records[i].get("DLMC") + ",";
																			  jsSFDYXZSJ += records[i].get("SFDYXZSJ") + ",";
																			  jsFWZP += records[i].get("FWZP") + ",";
																			  
																			  
																			  jsSql = jsSql + "\"Id\" = " +	id + " OR ";										 
																		  }
																		  
																		  Ext.Ajax.request({											  
										                                        //设置提交的地址  
										                                        url:'saveCard.action',  
										                                        //设置提交的方式为post  
										                                        
										                                        params : {
										                            				houseNumber: "" + jsHouseNumber + "",
										                            				QSDWMC: "" + jsQSDWMC + "",
										                            				DYNHXM: "" + jsDYNHXM + "",
										                            				DYNHSFZ: "" + jsDYNHSFZ + "",
										                            				Shape_Area: "" + jsShape_Area + "",
										                            				FWJG: "" + jsFWJG + "",
										                            				FWSYSJ: "" + jsFWSYSJ + "",
										                            				DLMC: "" + jsDLMC + "",
										                            				SFDYXZSJ: "" + jsSFDYXZSJ + "",
										                            				FWZP: "" + jsFWZP + "",
										                            				projectID: "" + jsProjectID + ""
										                            			},
										                                        method: 'post',  


										                                        //网络成功返回  
										                                        success: function(form, action) {  
										                                        	window.location.href = "downPlan.action";
										                                        	Ext.Msg.alert("提示", "保存成功");
										                                        	//调用下载
										                                        },  
										                                        //网络失败返回  
										                                        failure: function(form, action) {  
										                                            Ext.Msg.alert("提示", "保存失败");
										                                        }  
										                                  }); 
																		  
																		  jsSelectCommon(jsSql, jsProjectID);
																		  msgEdit = Ext.MessageBox.show({
														            	    	title:'提示',
														            	    	width : 250,
														            	    	msg:'正在筛选居民点,请稍后......',
														            	    	progress:true,  
														            	    	closable:false,  
														            	    	
														            	    			
										    		    	    		  }); 
																		  
																		  jsNumberCard = 5;	
																		  msgEdit.on('hide',function(){ 
																			  if (jsNumberCard != 5) {
																				  return;
																			  }
																			  jsNumberCard = 6;
																			  var jsJson = JSON.stringify(jsFJMD.toJson());
																			  Ext.Ajax.request({
											                                        //设置提交的地址  
											                                        url:'saveSpatial.action',  
											                                        //设置提交的方式为post  
											                                        
											                                        params : {
											                            				projectID: "" + jsProjectID + "",
											                            				spatialContent: "" + jsJson + ""
											                            				
											                            			},
											                                        method: 'post',  


											                                        //网络成功返回  
											                                        success: function(form, action) {  
											                                        	Ext.Msg.alert("提示", "保存成功");
											                                        	jsEditOnline(jsProjectID, jsHouseNumber);
											                                        	//调用下载
											                                        },  
											                                        //网络失败返回  
											                                        failure: function(form, action) {  
											                                            Ext.Msg.alert("提示", "保存失败");
											                                        }  
											                                    });
																			  Ext.getCmp('planWindow').close();
																		  });
																	  }else{
																		  Ext.Msg.alert("警告!" ,"至少选择一个居民点！");
																	  }								  
																	  
																	  break;
																  
																  default:
																	  break;
																  } 
									    	    				  
									    	    				  
									    	    				//  button.setDisabled(!cards.getNext());	    
									    	    				  
								    		    	    		//  jsOverlay();
								    		    	    			  
								    		    	    	  }
								    		    	    	  
								    		    	      },
//								    		    	      {
//								    		    	    	  xtype: 'button',
//								    		    	    	  text: '保存当前操作',
//								    		    	    	  width: 70,
//								    		    	    	  hide: true,
//								    		    	    	  listener: {
//								    		    	    		  click: {
//								    		    	    	//		  fn: me.onSave,
//								    		    	    	//		  scope: me
//								    		    	    		  }
//								    		    	    	  }
//								    		    	      },
								    		    	      {
								    		    	    	  xtype: 'button',
								    		    	    	  text: '退出向导',
								    		    	    	  width: 70,
								    		    	    	  handler: function(){
								    		    	    		  projectionWindow.destory();
								    		    	    	  }
								    		    	      }
								    		    	 ]
								    		     }		        
								    		]
								    	}).show();
								  }else{
									  Ext.Msg.alert('提示', "请选择一个项目");
								  }
								  
							  },
							  width: 70,

						  },
							  
						  {
							  xtype: 'button',
							  text: '取消',
							  handler: function(){
								  projectionWindow.destroy();
							  },
							  width: 70,
						  },
					 ]
				 }
					 
    		]
	    		 
	    });
	    projectionWindow.add(projectionPanel);
	    projectionWindow.show();
    	

    },

    /////
    
    
    
    ////
    onLoadGH: function(button, e, eOpts) {
    	var jsLoadCount = 1;
    		Ext.MessageBox.wait("载入中...", "提示", {   
	            interval: 100       //进度条加载速度   
	        }); 
	        Ext.Ajax.request({  
	            url: "loadGH.action",  
	            params:{
	            	loadCount : "" + jsLoadCount + ""
	            },
	            timeout: 600000,
	            success: function (reponse, option) {  

              
	            	jsLoadCount++; 
	                var appStore = Ext.create('Ext.data.Store', {
	                	timeout: 600000,   
	            	    proxy: {
	            	        // load using HTTP
	            	        type: 'ajax',
	            	        url: 'loadGH.action',  
	            	        
	            	        // the return will be XML, so lets set up a reader
	            	        reader:{
	                			type:"json",
	                			root:"results",
	                			totalProperty :'totalCount'		
	                		},
	                		actionMethods: {  
	                            read: 'POST'  
	                        },
	                		writer:{
	                			type:"json"
	                		}
	            	    },
	            	    listeners:{
	            	    	beforeload:function(){
	            	    		   
	            	    	}
	            	    },
	                    fields: [
	            		        {name: 'featureSet',  type: 'string'},  
	                 	        {name: 'fields',  type: 'string'},  
	                 	        {name: 'extent',  type: 'string'},
	                 	        {name: 'drawingInfo', type: 'string'},	                 	
	                 	        ]
	            	    
	            	});
	            	    
	            		
	            	    
	            		appStore.load({params:{
        	            	loadCount : "" + jsLoadCount + ""
        	            }},{
		            		callback: function(records, options, success){
		            			
		            
		                		//遍历store
		                		appStore.each(function(record) {
		                			
		                			jsFeatureSet = record.get("featureSet");
		                			jsFields = record.get("fields");
		                			jsExtent = record.get("extent");
		                			jsDrawingInfo = record.get("drawingInfo");
		                		});
		    	                Ext.MessageBox.hide();   // 加载完成，关闭提示框     	
		    	                
		    	                		    	           		    	             	                
		    	                jsFeatureSet = jsFeatureSet.replace(/'/ig, "\"");		
		    	                Ext.Msg.alert("1", jsFeatureSet);
		    	         		jsFields = jsFields.replace(/'/ig, "\"");	
		    	      
		    	                jsExtent = jsExtent.replace(/'/ig, "\"");	
		    	     
		    	                jsDrawingInfo = jsDrawingInfo.replace(/'/ig, "\"");	

		    	    
		    	                var featureCollection = {
		    	                    "layerDefinition": null,
		    	                    "featureSet": JSON.parse(jsFeatureSet)
		    	                };
		    	               
		    	                featureCollection.layerDefinition = {
		    	                	"geometryType": "esriGeometryPolygon",
		    	                	"drawingInfo": JSON.parse(jsDrawingInfo),
		    //	                	"extent": jsExtent,
		    	                	"fields": JSON.parse(jsFields)
		    	                };
		    	     
		    //	                Ext.Msg.alert("1", JSON.stringify(featureCollection));
		  
		    	   
		    	                jsAddFeatureLayer(featureCollection);
		    	                
		            //    		Ext.Msg.alert("提示", "加载完成");
		            		}
	            		});
	
	            },  
	            failure: function () {  
	                Ext.MessageBox.hide();   
	                Ext.Msg.alert("提示", "加载失败！");   
	            }  
	        });  
	       }

});