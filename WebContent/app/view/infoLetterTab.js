/*
 * File: app/view/infoLetterTab.js
 *
 * This file was generated by Sencha Architect version 3.1.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.view.infoLetterTab', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.infoLetterTab',

    requires: [
        'Ext.form.Panel',
        'Ext.grid.Panel',
        'Ext.grid.RowNumberer',
        'Ext.grid.column.Date',
        'Ext.grid.View',
        'Ext.selection.CheckboxModel',
        'Ext.form.field.Date',
        'Ext.button.Button',
        'Ext.toolbar.Paging'
    ],

    id: 'infoLetterTab',
    layout: 'fit',
    title: '监管>>群众来信',

    initComponent: function() {
        var me = this;

        Ext.applyIf(me, {
            items: [
                {
                    xtype: 'form',
                    height: 421,
                    autoScroll: true,
                    layout: 'border',
                    bodyPadding: 10,
                    jsonSubmit: true,
                    items: [
                        {
                            xtype: 'gridpanel',
                            region: 'center',
                            id: 'letterGridPanel',
                            collapsible: false,
                            title: '',
                            forceFit: true,
                            store: 'InfoLetterStore',
                            columns: [
                                {
                                    xtype: 'rownumberer',
                                    width: 37
                                },
                                {
                                    xtype: 'gridcolumn',
                                    dataIndex: 'letterTitle',
                                    text: '来信主题'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    dataIndex: 'letterAuthor',
                                    text: '来信人'
                                },
                                {
                                    xtype: 'datecolumn',
                                    dataIndex: 'letterWritetime',
                                    text: '来信时间',
                                    format: 'Y-m-d'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    dataIndex: 'letterIsreply',
                                    text: '是否回复'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    dataIndex: 'letterIsshow',
                                    text: '是否公示'
                                }
                            ],
                            selModel: Ext.create('Ext.selection.CheckboxModel', {

                            }),
                            dockedItems: [
                                {
                                    xtype: 'toolbar',
                                    dock: 'top',
                                    frame: false,
                                    enableOverflow: true,
                                    items: [
                                        {
                                            xtype: 'datefield',
                                            id: 'searchDateLetter',
                                            width: 234,
                                            fieldLabel: '起始时间',
                                            labelWidth: 80,
                                            format: 'Y-m-d'
                                        },
                                        {
                                            xtype: 'textfield',
                                            id: 'searchKeywordLetter',
                                            width: 159,
                                            fieldLabel: '',
                                            labelWidth: 80,
                                            emptyText: '请输入搜索关键字'
                                        },
                                        {
                                            xtype: 'button',
                                            handler: function(button, event) {
                                                var getDate = Ext.util.Format.date(Ext.getCmp('searchDateLetter').getValue(),'Y-m-d');
                                                var getKeyword = Ext.getCmp('searchKeywordLetter').getValue();
                                                var mystore=Ext.StoreMgr.get('InfoLetterStore'); //获得store对象
                                                //在load事件中添加参数
                                                //mystore.load(
                                                //{params:{
                                                //    start:"0",
                                                //    limit:"25",
                                                //    searchKeyword:getKeyword,
                                                //    searchDate:getDate
                                                //}
                                                //}
                                                //);



                                                mystore.on('beforeload',function(store,options){

                                                    var new_params = {
                                                        searchKeyword:getKeyword,
                                                        searchDate:getDate
                                                    };

                                                    Ext.apply(store.proxy.extraParams,new_params);
                                                });

                                                mystore.load(
                                                {
                                                    params:{
                                                        start:"0",
                                                        limit:"25"
                                                    }
                                                }
                                                );
                                            },
                                            icon: 'images/file_view0.png',
                                            text: '搜索'
                                        },
                                        {
                                            xtype: 'button',
                                            handler: function(button, event) {
                                                var grid = Ext.getCmp('letterGridPanel');

                                                var record = grid.getSelectionModel().getSelection();

                                                if(record.length === 0){
                                                    Ext.Msg.alert('提示','请先选择您要操作的行！');
                                                    return;

                                                }else{

                                                    var  letterIds =new Array(record.length);
                                                    for(var i = 0;i<record.length;i++){
                                                        letterIds[i] = record[i].get("letterId");

                                                    }
                                                    Ext.Msg.alert('提示',letterIds);



                                                    Ext.Ajax.request({
                                                        url:'del_letterByIds',
                                                        params:{letterIds:letterIds},

                                                        success:function(response){
                                                            Ext.Msg.alert('成功','信件已删除');
                                                            var mystore = Ext.StoreMgr.get('InfoLetterStore');
                                                            mystore.load();


                                                        }

                                                    });

                                                }
                                            },
                                            icon: 'images/table_delete.png',
                                            text: '删除来信'
                                        }
                                    ]
                                },
                                {
                                    xtype: 'pagingtoolbar',
                                    dock: 'bottom',
                                    height: 36,
                                    width: 360,
                                    displayInfo: true,
                                    store: 'InfoLetterStore'
                                }
                            ],
                            listeners: {
                                cellclick: {
                                    fn: me.onGridpanelCellClick,
                                    scope: me
                                }
                            }
                        }
                    ]
                }
            ]
        });

        me.callParent(arguments);
    },

    onGridpanelCellClick: function(tableview, td, cellIndex, record, tr, rowIndex, e, eOpts) {
        if(cellIndex === undefined || cellIndex < 2) return;


        //var newArticleTab = Ext.widget('infoArtilceScanTab');



        var win = new Ext.Window({

            title:'来信详细信息',
            closable:true,
            layout:'fit',
            items:[
            {
                xtype: 'form',
                height: 600,
                layout: {
                    type: 'absolute'
                },
                id:'letterDetailForm',
                jsonSubmit: true,
                bodyPadding: 10,
                items: [
                {
                    xtype: 'displayfield',
                    hidden: true,
                    id: 'letterId',
                    name:'letterId',
                    width: 780,
                    fieldLabel: '来信主题',
                    labelWidth: 80
                },
                {
                    xtype: 'displayfield',
                    hidden: true,
                    id: 'letterIsreply',
                    name: 'letterIsreply',
                    width: 780,
                    fieldLabel: '来信主题',
                    labelWidth: 80
                },
                {
                    xtype: 'displayfield',
                    hidden: true,
                    id: 'letterReplytime',
                    name: 'letterReplytime',
                    width: 780,
                    fieldLabel: '来信主题',
                    labelWidth: 80
                },
                {
                    xtype: 'displayfield',
                    id: 'letterTitle',
                    name: 'letterTitle',
                    width: 780,
                    fieldLabel: '来信主题',
                    labelWidth: 80
                },
                {
                    xtype: 'displayfield',
                    x: 10,
                    y: 40,
                    id: 'letterAuthor',
                    name: 'letterAuthor',
                    width: 230,
                    fieldLabel: '来信人姓名',
                    labelWidth: 80
                },
                {
                    xtype: 'displayfield',
                    x: 260,
                    y: 70,
                    id: 'letterTel',
                    name: 'letterTel',
                    width: 230,
                    fieldLabel: '联系电话',
                    labelWidth: 80
                },
                {
                    xtype: 'displayfield',
                    x: 510,
                    y: 70,
                    id: 'letterAddress',
                    name: 'letterAddress',
                    width: 280,
                    fieldLabel: '通讯地址',
                    labelWidth: 80
                },
                {
                    xtype: 'displayfield',
                    x: 10,
                    y: 70,
                    id: 'letterAuthorcardid',
                    name: 'letterAuthorcardid',
                    width: 230,
                    fieldLabel: '身份证号',
                    labelWidth: 80
                },
                {
                    xtype: 'displayfield',
                    x: 260,
                    y: 40,
                    id: 'letterEmail',
                    name: 'letterEmail',
                    width: 230,
                    fieldLabel: '电子邮件',
                    labelWidth: 80
                },
                {
                    xtype: 'displayfield',
                    x: 510,
                    y: 40,
                    id: 'letterWritetime',
                    name: 'letterWritetime',
                    width: 230,
                    fieldLabel: '来信时间',
                    labelWidth: 80
                },
                {
                    xtype: 'displayfield',
                    x: 10,
                    y: 100,
                    height: 180,
                    id: 'letterContent',
                    name: 'letterContent',
                    width: 780,
                    fieldLabel: '来信内容',
                    labelWidth: 80
                },
                {
                    xtype: 'textareafield',
                    x: 10,
                    y: 280,
                    height: 180,
                    id: 'letterReplycontent',
                    name: 'letterReplycontent',
                    width: 780,
                    fieldLabel: '回复内容',
                    labelWidth: 80
                },
                {
                    xtype: 'radiogroup',
                    x: 10,
                    y: 470,
                    id: 'letterIsshow',
                    fieldLabel: '是否公示：',
                    labelWidth: 80,
                    items: [
                    {
                        xtype: 'radiofield',
                        name: 'letterIsshow',
                        boxLabel: '是',
                        inputValue: '是'
                    },
                    {
                        xtype: 'radiofield',
                        name: 'letterIsshow',
                        boxLabel: '否',
                        inputValue: '否'
                    }
                    ]
                },
                {
                    xtype: 'button',
                    handler: function(button, event) {

                        var myform = Ext.getCmp('letterDetailForm').getForm();
                        if (myform.isValid()) { // make sure the form contains valid data before submitting
                            myform.submit({
                                url:'update_letter',
                                success: function(form, action) {
                                    Ext.Msg.alert('成功', '成功回复');

                                    var mystore = Ext.StoreMgr.get('InfoLetterStore'); //获得store对象
                                    mystore.load();
                                    //{
                                    //params: {
                                    // start: "0",
                                    // limit: "25"
                                    //searchField: Ext.getCmp('searchField_pubNewDynamic').getValue(),
                                    //searchDate: Ext.util.Format.date(Ext.getCmp('searchDate_pubNewDynamic').getValue(), 'Y-m-d');
                                    //}
                                    //}
                                    // );

                                    win.close();

                                },
                                failure: function(form, action) {
                                    Ext.Msg.alert('failure', '回复失败');
                                    win.close();
                                }
                            });
                        } else {
                            Ext.Msg.alert('注意', '填写信息不能为空，请检查！');
                        }

                        return;






                    },
                    x: 10,
                    y: 510,
                    text: '回复并发送邮件'


                },
                {
                    xtype: 'button',
                    handler: function(button, event) {
                        win.close();
                    },
                    x: 160,
                    y: 510,
                    width: 90,
                    text: '取消'
                }
                ]
            }

            ]
        });


        Ext.getCmp('letterId').setValue(record.data.letterId);
        Ext.getCmp('letterTitle').setValue(record.data.letterTitle);
        Ext.getCmp('letterContent').setValue(record.data.letterContent);
        Ext.getCmp('letterAuthor').setValue(record.data.letterAuthor);
        Ext.getCmp('letterIsreply').setValue(record.data.letterIsreply);
        Ext.getCmp('letterIsshow').setValue({letterIsshow:record.data.letterIsshow});
        Ext.getCmp('letterReplycontent').setValue(record.data.letterReplycontent);
        Ext.getCmp('letterTel').setValue(record.data.letterTel);
        Ext.getCmp('letterEmail').setValue(record.data.letterEmail);
        Ext.getCmp('letterAddress').setValue(record.data.letterAddress);
        Ext.getCmp('letterWritetime').setValue(record.data.letterWritetime);
        Ext.getCmp('letterReplytime').setValue(record.data.letterReplytime);
        Ext.getCmp('letterAuthorcardid').setValue(record.data.articleIsrecycle);


        //var letterIsshow = Ext.getCmp('letterIsshow').getValue().inputValue;


        win.show();
    }

});