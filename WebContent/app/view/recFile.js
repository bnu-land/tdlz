/*
 * File: app/view/recFile.js
 *
 * This file was generated by Sencha Architect version 2.2.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.view.recFile', {
    extend: 'Ext.container.Container',
    alias: 'widget.recFile',

id: 'RecFile',
    layout: {
        type: 'card'
    },

    initComponent: function() {
        var me = this;

        
        
        
        
        Ext.applyIf(me, {
            items: [
                {
                    xtype: 'gridpanel',
                    id: 'listFile',
                    title: '上传文件',
                    store: 'listFile',
                    columns: [
						{
						    xtype: 'gridcolumn',
						    id: 'projectIDFile',
						    width: 357,
						    dataIndex: 'projectID',
						    text: '项目编号'
						},      
                        {
                            xtype: 'gridcolumn',
                            id: 'categoryFile',
                            width: 357,
                            dataIndex: 'category',
                            text: '文件名称'
                        },
                        {
                            xtype: 'gridcolumn',
                            id: 'status',
                            dataIndex: 'statusUp',
                            text: '状态',
                            
                        },
                        {
                            xtype: 'actioncolumn',
                            id: 'upLoad',
                            width: 27,
                            items: [
                                {
                                    
                                	handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                		 
                                		var jsFileName = record.get("category");
                                		var jsID = record.get("id");	
                                		var jsProjectID = record.get("projectID");
                                		var fp = new Ext.FormPanel( {
                                		       renderTo : Ext.getBody(),
                                		       fileUpload : true,
                                		       width : 523,
                                		       frame : true,
                                		       autoHeight : true,
                                		       bodyStyle : 'padding: 10px 10px 0 10px;',
                                		       labelWidth : 50,
                                		       defaults : {
                                		           anchor : '95%',
                                		           allowBlank : false,
                                		           msgTarget : 'side'
                                		       },
                                		         items : [
                                		                            new Ext.form.FileUploadField( {
                                		              buttonText: '浏览...',
                                		              emptyText: '请选择一个文件',
                                		              name : 'upload',
                                		              width : 500,
                                		              buttonCfg: {
                                		                  width: 40,
                                		                  iconCls: 'upload-icon'
                                		              }
                                		           }) 
                                		    ],
                                		        buttons : [ {
                                		           text : '上传',
                                		           handler : function() {
                                		              if (fp.getForm().isValid()) {
                                		                  fp.getForm().submit( {
                       	  
                                		                     method : 'post',
                                		                     url :'upload.action',// 后台处理的action
                                		                     params:{
                                		                    	 fileName :"" + jsFileName + "",
                                		                    	 id :  "" + jsID + "",
                                		                    	 projectID: "" + jsProjectID + ""
                                		                     },
                                		                     waitMsg : '操作处理中，请稍等...',
                                		                      waitTitle:'提示',
                                		                     success :function(fp,action){
                                		                    	 Ext.Msg.alert("上传成功");
                             		                             Ext.getCmp('listFile').getStore().reload();
                                		                         excelWindow.destroy();
                                		                     },
                                		                     failure : function(fp, action) {
                                		                     
                                		                            
                                		                            excelWindow.destroy();
                                		                     }
                                		              });
                                		                		
                                		                            }
                                		                   }
                                		         }]
                                		});
                                		 
                                		var excelWindow = new Ext.Window( {
                                		       renderTo : Ext.getBody(),
                                		       closeAction : "hide",
                                		       plain : true,
                                		       width : 540,
                                		       title : "上传文件",
                                		       modal : true,
                                		       items:[fp]
                                		    });
                                		excelWindow.show();
                                		
                                		
                                          /*                  	
                                		var fpFileUpload=new Ext.FormPanel({  
                                            id:'fpFileUpload',  
                                            frame:true,  
                                            fileUpload:true,  
                                            
                                            items:[  
                                                {  
                                                    xtype:'textfield',  
                                                    allowBlank:false,  
                                                    fieldLabel:'选择文件',  
                                                    inputType:'file',  
                                                    name:'upload'  
                                                }  
                                            ],  
                                            buttonAlign:'center',  
                                            buttons:[  
                                                {  
                                                    text:'上传',  
                                                    handler:function(){  
                                                                                                	
                                                        if(fpFileUpload.form.isValid()){  
                                                        	
                                                            fpFileUpload.form.submit({ 
                                                        	
                                                            	url : "upload.action",
                                                                method :'post',  

 
                                                                //waitMsg:'文件上传中...',  
                                                                success: function() {  
                                                                    alert("系统提示", "文件上传成功！");  
                                                                },  
                                                                failure: function() {  
                                                                    alert("系统提示", "文件上传失败！");  
                                                                }  
                                                            });  
                                                        }else{  
                                                            Ext.Msg.alert("系统提示","请选择文件后再上传！");  
                                                        }  
                                                    }  
                                                },  
                                                {  
                                                    text:'取消',  
                                                    handler:function(){  
                                                        winFielUpload.hide();  
                                                    }  
                                                }  
                                            ]  
                                        });  
                                    	
                                    	
                                    	var winFielUpload=new Ext.Window({  
                                            id:'win',  
                                            title:'文件上传',  
                                            //****renderTo:'divWindow',//对于window不要使用renderTo属性，只需要调用show方法就可以显示，添加此属性会难以控制其位置  
                                            width:350,  
                                            height:100,  
                                            layout:'fit',  
                                            autoDestory:true,  
                                            modal:true,  
                                            closeAction:'hide',  
                                            items:[  
                                                fpFileUpload  
                                            ]  
                                        });  
                                        window.winFielUpload=winFielUpload;
                                        
                                        winFielUpload.show();
                                        
/*
                                        var win=new Ext.Window({
                            
                                    		title:"上传文件",

                                    		id : "fileUploadForm",                                          
                                            modal: true,
                                            items:[
                                            {
                                                xtype:"form",
                                                id:"file",
                                                width:600,
                                                height:400,
                                                autoScroll:true,
                                                frame: true,
                                                items:[{
                                                    xtype:"image",
                                                    id:"img"

                                                }]
                                            }
                                            ],
                                            
                                            buttons:[{
                                                //xtype: 'filefield',
       
                                                
                                                /*
                                                inputType : "file",
                                                hideLabel: true,
                                                buttonText:'浏览',        
                                                flex: 1,
                                                fieldLabel: 'Label',
                                                
                                                
                                                listeners: {
                                                    change: function(filefield, value, eOpts) {
                                                        Ext.getCmp("img").setSrc(Ext.getCmp("UPload").getValue());
                                                        
                                                    } }               
                                                },
                                                {
                                                    xtype:"button",
                                                    text:"提交",
                                                    handler:function(){
                                                    	//alert(Ext.getCmp("filefield").getForm());
                                                    	Ext.Ajax.request({
                                                    		url : "upload.action",
                                                    		method : "POST",
                                                    		success : function(form, action) {
                                                    		alert("success");
                                                    		},
                                                    		failure : function(form, action) {
                                                    		alert("failure");
                                                    		}
                                                    		});
                                                    	
                                                    	win.close();
                                                    }
                                                },
                                                {
                                                    xtype:"button",
                                                    text:"退出",
                                                    handler:function(){win.close();}
                                                }
                                                ]

                                            });
            */                            
                              //              win.show();
                               
            
                                            
                                    	
                                    	
                                    },
                                    
                                    
                                    icon: 'img/upload.png'
                                }
                                
                                    	
                                    	
                            ]
                        }
                    ],
                    dockedItems: [
                        {
                            xtype: 'pagingtoolbar',
                            dock: 'top',
                            width: 360,
                            displayInfo: true,
                            store: 'listFile',
                            items: [
                                {
                                    xtype: 'button',
                                    text: '执行',
                                    listeners: {
                                        click: {
                                            fn: me.onButtonClick,
                                            scope: me
                                        }
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    xtype: 'gridpanel',
                    id: 'audFile',
                    title: '审核文件',
                    store: 'listFile',
                    columns: [
						{
						    xtype: 'gridcolumn',
						    id: 'projectFileAud',
						    width: 150,
						    dataIndex: 'projectID',
						    text: '项目编号'
						},
                        {
                            xtype: 'gridcolumn',
                            id: 'categoryFileAud',
                            width: 357,
                            dataIndex: 'category',
                            text: '文件名称'
                        },
                        {
                            xtype: 'gridcolumn',
                            id: 'statusAud',
                            dataIndex: 'statusAug',
                            text: '状态'
                        },
                        {
                            xtype: 'actioncolumn',
                            id: 'audit',
                            text: '下载文件',
                            width: 27,
                            items: [
                                {
                                    handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                    	var jsPath = record.get("path");
                                    	
                                  
//                                    	document.write("<form action=download.action method=post name=form1 style='display:none'>");  
//                                    	document.write("<input type=hidden name=path value="+jsPath+"");  
//                                    	
//                                    	document.write("</form>");  
//                                    	document.form1.submit();  
                                    	
                                    	window.location.href = "download.action?path="+jsPath+"";
                                         	
                     
                                    	
                                    	},
                                    
                                    
                                    	icon: 'img/aud.png'
                                }
                                
                            ]
                        
                        }
                        
                    ],
                    viewConfig: {
                        id: 'auditCK',
                        enableTextSelection: true
                    },
                    selModel: Ext.create('Ext.selection.CheckboxModel', {

                    }),
                    dockedItems: [
                        {
                            xtype: 'pagingtoolbar',
                            dock: 'top',
                            width: 360,
                            displayInfo: true,
                            store: 'listFile',
                            items: [
                                {
                                    xtype: 'button',
                                    text: '批量审核',
                                    listeners: {
                                        click: {
                                            fn: me.onButtonClick1,
                                            scope: me
                                        }
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    xtype: 'gridpanel',
                    id: 'statusFile',
                    title: '查看状态',
                    store: 'listFile',
                    columns: [
						{
						    xtype: 'gridcolumn',
						    id: 'projectFileAud',
						    width: 150,
						    dataIndex: 'projectID',
						    text: '项目编号'
						},
                        {
                            xtype: 'gridcolumn',
                            id: 'categoryFileStatus',
                            width: 357,
                            dataIndex: 'category',
                            text: '文件名称'
                        },
                        {
                            xtype: 'gridcolumn',
                            id: 'statusFileStatus',
                            dataIndex: 'statusAug',
                            text: '状态'
                        }
                    ]
                }
            ]
        });
 
        me.callParent(arguments);
    },

    onButtonClick: function(button, e, eOpts) {

    },

    //审核
    onButtonClick1: function(button, e, eOpts) {
    	Ext.Msg.confirm('提示', '请给出审核结果！', isOK);
        function isOK(id){
        if (id == 'yes') {
        	alert(Ext.getCmp("audFile").getSelectionModel().hasSelection());
    		if (Ext.getCmp("audFile").getSelectionModel().hasSelection())
			{
    			alert("进入selete");
				var records=Ext.getCmp("audFile").getSelectionModel().getSelection();
				var JSstatus = "审核通过";
				for(var i=0;i<records.length;i++){
					var id = records[i].get("id");
					  
					  Ext.Ajax.request({
						   url:'auditRecord.action',
						   method:'post',
						   params:{id :"" + id + "",
							   statusAug : "" + JSstatus + ""
						   },
						   success:function(){										   
							   
							   Ext.Msg.alert("审核完成！");
							   Ext.getCmp("audFile").getStore().reload();
							 
						   }
						   });
				}
			}
        	}
        else
        	{
	        	if (Ext.getCmp("audFile").getSelectionModel().hasSelection())
				{
	    			//alert("进入selete");
					var records=Ext.getCmp("audFile").getSelectionModel().getSelection();
					var JSstatus = "审核未通过";
					for(var i=0;i<records.length;i++){
						var id = records[i].get("id");
						  
						  Ext.Ajax.request({
							   url:'auditRecord.action',
							   method:'post',
							   params:{id :"" + id + "",
								   statusAug : "" + JSstatus + ""
							   },
							   success:function(){										   
								   
								   Ext.Msg.alert("审核完成！");
								   Ext.getCmp("audFile").getStore().reload();
								 
							   }
							   });
					}
				}
        	}
        }
    	
    }

});